{% extends 'admin/admin_dashboard_base.html'%}
{% load static %}
{% block title%}| Welcome {% endblock %}

{% block styles %}


{% endblock %}


{% block content %}

<div class="main-content">

<div class="page-content">
<div class="container-fluid">

<div class="row">
<div class="col-xl-4">
<div class="card overflow-hidden">
<div class="bg-primary-subtle">
<div class="row">
<div class="col-7">
<div class="text-primary p-3">
<h5 class="text-primary">Welcome Back !</h5>
<p>Admin Dashboard</p>
</div>
</div>
<div class="col-5 align-self-end">
<img src="{% static 'admin_assets/images/profile-img.png' %}" alt="" class="img-fluid">
</div>
</div>
</div>
<div class="card-body pt-0">
<div class="row">
<div class="col-sm-4">
<div class="avatar-md profile-user-wid mb-4">
<img src="{% static 'admin_assets/images/users/avatar-1.jpg' %}" alt="" class="img-thumbnail rounded-circle">
</div>
<h5 class="font-size-15 text-truncate">{{user.get_full_name}}</h5>
<p class="text-muted mb-0 text-truncate">Admin Officer</p>
</div>

<div class="col-sm-8">
<div class="pt-4">

<div class="row">
<div class="col-6">
<h5 class="font-size-15">{{ assigned_count }}</h5>
<p class="text-muted mb-0">Assigned</p>
</div>
<div class="col-6">
<h5 class="font-size-15">{{ initiated_count }}</h5>
<p class="text-muted mb-0">Initiated</p>
</div>
</div>
<div class="mt-4">
<a href="javascript: void(0);" class="btn btn-primary waves-effect waves-light btn-sm">View Profile <i class="mdi mdi-arrow-right ms-1"></i></a>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="card">
<div class="card-body">
<h4 class="card-title mb-4">Monthly Output</h4>
<div class="row">
<div class="col-sm-6">
<p class="text-muted">This month</p>
<h3>5</h3>
<p class="text-muted"><span class="text-success me-2"> 12% <i class="mdi mdi-arrow-up"></i> </span> From previous period</p>

<div class="mt-4">
<a href="javascript: void(0);" class="btn btn-primary waves-effect waves-light btn-sm">View More <i class="mdi mdi-arrow-right ms-1"></i></a>
</div>
</div>
<div class="col-sm-6">
<div class="mt-4 mt-sm-0">
<div id="radialBar-chart" data-colors='["--bs-primary"]' class="apex-charts"></div>
</div>
</div>
</div>
<p class="text-muted mb-0">Total Applications Processed for the month.</p>
</div>
</div>
</div>
<div class="col-xl-8">
<div class="row">



<div class="col-md-3">
<div class="card mini-stats-wid">
<div class="card-body">
<div class="d-flex">
<div class="flex-grow-1">
<p class="text-muted fw-medium">Total Application</p>
<h4 class="mb-0">{{ applications_count }}</h4>
</div>
<div class="flex-shrink-0 align-self-center">
<div class="mini-stat-icon avatar-sm rounded-circle bg-primary">
<span class="avatar-title">
<i class="bx bx-copy-alt font-size-24"></i>
</span>
</div>
</div>
</div>
</div>
</div>
</div>


<div class="col-md-3">
<div class="card mini-stats-wid">
<div class="card-body">
<div class="d-flex">
<div class="flex-grow-1">
<p class="text-muted fw-medium">Admin Review</p>
<h4 class="mb-0">{{ admin_review_count }}</h4>
</div>
<div class="flex-shrink-0 align-self-center">
<div class="avatar-sm rounded-circle bg-primary mini-stat-icon">
<span class="avatar-title rounded-circle bg-primary">
<i class="bx bx-archive-in font-size-24"></i>
</span>
</div>
</div>
</div>
</div>
</div>
</div>

<div class="col-md-3">
<div class="card mini-stats-wid">
<div class="card-body">
<div class="d-flex">
<div class="flex-grow-1">
<p class="text-muted fw-medium">Awaiting Decision</p>
<h4 class="mb-0">{{ awaiting_decision_count }}</h4>
</div>
<div class="flex-shrink-0 align-self-center">
<div class="avatar-sm rounded-circle bg-primary mini-stat-icon">
<span class="avatar-title rounded-circle bg-primary">
<i class="bx bxs-hourglass font-size-24"></i>
</span>
</div>
</div>
</div>
</div>
</div>
</div>

<div class="col-md-3">
<div class="card mini-stats-wid">
<div class="card-body">
<div class="d-flex">
<div class="flex-grow-1">
<p class="text-muted fw-medium">Complete</p>
<h4 class="mb-0">{{ complete_count }}</h4>
</div>
<div class="flex-shrink-0 align-self-center">
<div class="avatar-sm rounded-circle bg-primary mini-stat-icon">
<span class="avatar-title rounded-circle bg-primary">
<i class="bx bx-analyse font-size-24"></i>
</span>
</div>
</div>
</div>
</div>
</div>
</div>


</div>
<!-- end row -->

<div class="card">
<div class="card-body">
<div class="d-sm-flex flex-wrap">
<h4 class="card-title mb-4">Visa Applications</h4>
<div class="ms-auto">
<ul class="nav nav-pills">
<li class="nav-item">
<a class="nav-link" href="#">Week</a>
</li>
<li class="nav-item">
<a class="nav-link" href="#">Month</a>
</li>
<li class="nav-item">
<a class="nav-link active" href="#">Year</a>
</li>
</ul>
</div>
</div>

<div id="stacked-column-chart" data-colors='["--bs-primary", "--bs-warning", "--bs-success"]' class="apex-charts" dir="ltr"></div>
</div>
</div>
</div>
</div>
<!-- end row -->

<div class="row">
<div class="col-xl-4">
<div class="card">
<div class="card-body">
<h4 class="card-title mb-4">Social Source</h4>
<div class="text-center">
<div class="avatar-sm mx-auto mb-4">
<span class="avatar-title rounded-circle bg-primary-subtle font-size-24">
<i class="mdi mdi-facebook text-primary"></i>
</span>
</div>
<p class="font-16 text-muted mb-2"></p>
<h5><a href="javascript: void(0);" class="text-dark">Facebook - <span class="text-muted font-16">125 mentions</span> </a></h5>
<p class="text-muted">Total leads generated from online sources</p>
<a href="javascript: void(0);" class="text-primary font-16">Learn more <i class="mdi mdi-chevron-right"></i></a>
</div>
<div class="row mt-4">
<div class="col-4">
<div class="social-source text-center mt-3">
<div class="avatar-xs mx-auto mb-3">
<span class="avatar-title rounded-circle bg-primary font-size-16">
<i class="mdi mdi-facebook text-white"></i>
</span>
</div>
<h5 class="font-size-15">Facebook</h5>
<p class="text-muted mb-0">125 mentions</p>
</div>
</div>
<div class="col-4">
<div class="social-source text-center mt-3">
<div class="avatar-xs mx-auto mb-3">
<span class="avatar-title rounded-circle bg-info font-size-16">
<i class="mdi mdi-twitter text-white"></i>
</span>
</div>
<h5 class="font-size-15">Twitter</h5>
<p class="text-muted mb-0">112 mentions</p>
</div>
</div>
<div class="col-4">
<div class="social-source text-center mt-3">
<div class="avatar-xs mx-auto mb-3">
<span class="avatar-title rounded-circle bg-pink font-size-16">
<i class="mdi mdi-instagram text-white"></i>
</span>
</div>
<h5 class="font-size-15">Instagram</h5>
<p class="text-muted mb-0">104 mentions</p>
</div>
</div>
</div>

</div>
</div>
</div>
<div class="col-xl-4">
<div class="card">
<div class="card-body">
<h4 class="card-title mb-5">Activity</h4>
<ul class="verti-timeline list-unstyled">
<li class="event-list">
<div class="event-timeline-dot">
<i class="bx bx-right-arrow-circle font-size-18"></i>
</div>
<div class="d-flex">
<div class="flex-shrink-0 me-3">
<h5 class="font-size-14">10 Sep <i class="bx bx-right-arrow-alt font-size-16 text-primary align-middle ms-2"></i></h5>
</div>
<div class="flex-grow-1">
<div>
You have a pending request for A4 paper
</div>
</div>
</div>
</li>
<li class="event-list">
<div class="event-timeline-dot">
<i class="bx bx-right-arrow-circle font-size-18"></i>
</div>
<div class="d-flex">
<div class="flex-shrink-0 me-3">
<h5 class="font-size-14">10 Sep <i class="bx bx-right-arrow-alt font-size-16 text-primary align-middle ms-2"></i></h5>
</div>
<div class="flex-grow-1">
<div>
Admin has finalized 3 Applications sent for review  <a href="javascript: void(0);">View details</a>
</div>
</div>
</div>
</li>
<li class="event-list active">
<div class="event-timeline-dot">
<i class="bx bxs-right-arrow-circle font-size-18 bx-fade-right"></i>
</div>
<div class="d-flex">
<div class="flex-shrink-0 me-3">
<h5 class="font-size-14">10 Sep <i class="bx bx-right-arrow-alt font-size-16 text-primary align-middle ms-2"></i></h5>
</div>
<div class="flex-grow-1">
<div>3 visa applications submitted this week
</div>
</div>
</div>
</li>
<li class="event-list">
<div class="event-timeline-dot">
<i class="bx bx-right-arrow-circle font-size-18"></i>
</div>
<div class="d-flex">
<div class="flex-shrink-0 me-3">
<h5 class="font-size-14">10 Sep <i class="bx bx-right-arrow-alt font-size-16 text-primary align-middle ms-2"></i></h5>
</div>
<div class="flex-grow-1">
<div>
Case officers sent 2 applications to you
</div>
</div>
</div>
</li>
</ul>
<div class="text-center mt-4"><a href="javascript: void(0);" class="btn btn-primary waves-effect waves-light btn-sm">View More <i class="mdi mdi-arrow-right ms-1"></i></a></div>
</div>
</div>
</div>

<div class="col-xl-4">
<div class="card">
<div class="card-body">
<h4 class="card-title mb-4">Trending visa loctions</h4>

<div class="text-center">
<div class="mb-4">
<i class="bx bx-map-pin text-primary display-4"></i>
</div>
<h3>1,456</h3>
<p>United Kingdom</p>
</div>

<div class="table-responsive mt-4">
<table class="table align-middle table-nowrap">
<tbody>
<tr>
<td style="width: 30%">
<p class="mb-0">United Kingdom</p>
</td>
<td style="width: 25%">
<h5 class="mb-0">1,456</h5></td>
<td>
<div class="progress bg-transparent progress-sm">
<div class="progress-bar bg-primary rounded" role="progressbar" style="width: 94%" aria-valuenow="94" aria-valuemin="0" aria-valuemax="100"></div>
</div>
</td>
</tr>
<tr>
<td>
<p class="mb-0">Canada</p>
</td>
<td>
<h5 class="mb-0">1,123</h5>
</td>
<td>
<div class="progress bg-transparent progress-sm">
<div class="progress-bar bg-success rounded" role="progressbar" style="width: 82%" aria-valuenow="82" aria-valuemin="0" aria-valuemax="100"></div>
</div>
</td>
</tr>
<tr>
<td>
<p class="mb-0">United States</p>
</td>
<td>
<h5 class="mb-0">1,026</h5>
</td>
<td>
<div class="progress bg-transparent progress-sm">
<div class="progress-bar bg-warning rounded" role="progressbar" style="width: 70%" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100"></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<!-- end row -->

<div class="row">
<div class="col-lg-12">
<div class="card">
<div class="card-body">




<h4 class="card-title mb-4 text-info">Latest Applications</h4>
<div class="table-responsive">
<table id="datatable" class="table table-bordered dt-responsive">
<thead class="table-light">
<tr>
<!-- <th style="width: 20px;">
<div class="form-check font-size-16 align-middle">
<input class="form-check-input" type="checkbox" id="transactionCheck01">
<label class="form-check-label" for="transactionCheck01"></label>
</div>
</th> -->
<th class="align-middle">Reference No:</th>
<th class="align-middle">Name</th>
<th class="align-middle">Email</th>
<th class="align-middle">Type</th>
<th class="align-middle">Status</th>
<th class="align-middle">Date</th>
<th class="align-middle">View Details</th>
</tr>
</thead>


<tbody id="datatable-tbody">
  <tr>
    <td colspan="8" class="text-center text-muted">Loading applications...</td>
  </tr>
</tbody>

</table>
</div>
<!-- end table-responsive -->
</div>
</div>
</div>
</div>
<!-- end row -->

</div> <!-- container-fluid -->
</div>
<!-- End Page-content -->


<!-- Application Detail Modal -->
<div class="modal fade" id="applicationDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-success">Application Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="application-detail-content">
        <p class="text-muted">Select an application to view details.</p>
      </div>
    </div>
  </div>
</div>

<!-- jQuery (must come first) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function () {
    // 🔹 Initialize DataTable
    let table = $('#datatable').DataTable({
        ajax: {
            url: "/api/applications/",
            dataSrc: "" // change to "results" if API wraps results
        },
        order: [[5, "desc"]], // column index of "Created On / Date"
        columns: [
            { data: "reference_no" },
            { data: "client_name" },
            { data: "client_email" },
            { data: "visa_type_display" },
            {
                data: "status_display",
                render: function (data, type, row) {
                    return `<span class="badge ${row.status_badge}" id="application-status-badge-${row.id}">
                              ${data}
                            </span>`;
                }
            },
            {
                data: "created_at",
                render: function (data, type, row) {
                    return data ? data : "-";   // ✅ fallback to '-' if null/empty
                }
            },
            {
                data: "id",
                render: function (id, type, row) {
                    return `<button type="button"
                              class="btn btn-primary btn-sm btn-rounded view-details-btn"
                              data-id="${id}"
                              data-bs-toggle="modal"
                              data-bs-target="#applicationDetailModal">
                              View Details
                            </button>`;
                }
            }
        ],
        pageLength: 10,
        responsive: true,
        ordering: true
    });

    // 🔹 Handle "View Details" button click
    $('#datatable tbody').on('click', '.view-details-btn', function () {
        let appId = $(this).data('id');
        let modalBody = document.querySelector("#applicationDetailModal #application-detail-content");

        modalBody.innerHTML = "<p class='text-muted'>Loading...</p>";

        fetch(`/api/applications/${appId}/`)
            .then(res => res.json())
            .then(app => {
                  // ✅ Officer row logic with fallback
                let officerRow = "";
                if (app.created_by_officer_name) {
                    officerRow = `
                        <tr>
                            <th>Initiating Officer</th>
                            <td>${app.created_by_officer_name ?? '-'}</td>
                        </tr>
                    `;
                } else if (app.assigned_officer_name) {
                    officerRow = `
                        <tr>
                            <th>Assigned Officer</th>
                            <td>${app.assigned_officer_name ?? '-'}</td>
                        </tr>
                    `;
                } else {
                    officerRow = `
                        <tr>
                            <th>Officer</th>
                            <td>-</td>
                        </tr>
                    `;
                }

              let detailsHtml = `
                <h5 class="text-info">Application Info</h5>
                <table class="table table-bordered">
                  <tr><th>Reference</th><td>${app.reference_no}</td></tr>
                  <tr><th>Client</th><td>${app.client_name}</td></tr>
                  <tr><th>Email</th><td>${app.client_email}</td></tr>
                  <tr><th>Country</th><td>${app.country_display}</td></tr>
                  <tr><th>Visa Type</th><td>${app.visa_type_display}</td></tr>
                  <tr><th>Status</th>
                    <td><span id="application-status-badge" class="badge ${app.status_badge}">
                      ${app.status_display}
                    </span></td>
                  </tr>
                  ${officerRow}
                  <tr><th>Created On</th><td>${app.created_at ?? '-'}</td></tr>
                  <tr>
                  <tr>
                    <th>Visa Application URL</th>
                    <td id="visa-url-cell">
                      ${app.visa_application_url 
                        ? `<a href="${app.visa_application_url}" target="_blank">${app.visa_application_url}</a>
                           <a href="${app.visa_application_url}" target="_blank" class="btn btn-sm btn-soft-success ms-2">Go To URL</a>` 
                        : '<em>No URL added yet</em>'
                      }
                    </td>
                  </tr>
                  <tr><th>Submission Date</th><td id="submission-date-cell">${app.submission_date ?? '-'}</td></tr>
                  <tr><th>Decision Date</th><td>${app.decision_date ?? '-'}</td></tr>
                </table>
              `;

              // 🔹 Add Mark Finalized button (but will be locked later)
              if (app.status !== "SUBMITTED") {
                  detailsHtml += `
                    <div class="mt-3 text-end">
                      <button class="btn btn-success" id="mark-finalized-btn" data-id="${app.id}">
                        Mark Finalized
                      </button>
                    </div>
                  `;
              } else {
                  detailsHtml += `
                    <div class="mt-3 text-end">
                      <button class="btn btn-secondary" disabled>
                        ✅ Already Finalized
                      </button>
                    </div>
                  `;
              }

              // 🔹 Documents section
              let docsHtml = `
                <h5 class="mt-4 text-info">Documents</h5>
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Requirement</th>
                      <th>Status</th>
                      <th>File</th>
                      <th>Comments</th>
                      <th>Uploaded</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
              `;

              if (app.documents.length === 0) {
                  docsHtml += `<tr><td colspan="6" class="text-center text-muted">No documents uploaded yet.</td></tr>`;
              } else {
                  app.documents.forEach(doc => {
                      docsHtml += `
                        <tr>
                          <td>${doc.requirement_name}</td>
                          <td><span class="badge ${doc.status_badge}">${doc.status_display}</span></td>
                          <td>${doc.file ? `<a href="${doc.file}" target="_blank">View</a>` : '-'}</td>
                          <td>
                            <input type="text" class="form-control form-control-sm review-comment-input"
                                   data-doc-id="${doc.id}"
                                   value="${doc.review_comments ?? ''}"
                                   placeholder="Add comment">
                          </td>
                          <td>${doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleString() : '-'}</td>
                          <td>
                            <button class="btn btn-sm btn-success review-btn" data-id="${doc.id}">Mark Reviewed</button>
                          </td>
                        </tr>
                      `;
                  });
              }

              docsHtml += "</tbody></table>";
              modalBody.innerHTML = detailsHtml + docsHtml;

              // 🔒 Lock modal after rendering
              const modal = document.querySelector("#applicationDetailModal");

              // Disable all inputs
              modal.querySelectorAll("input, textarea, select").forEach(el => {
                el.setAttribute("readonly", true);
                el.setAttribute("disabled", true);
              });

              // Disable all buttons except modal close
              modal.querySelectorAll("button").forEach(btn => {
                if (!btn.classList.contains("btn-close")) {
                  btn.setAttribute("disabled", true);
                  btn.classList.add("disabled");
                }
              });

              // Disable all links except "Go To URL"
              modal.querySelectorAll("a").forEach(link => {
                if (!(link.textContent.includes("Go To URL") && link.classList.contains("btn-soft-success"))) {
                  link.setAttribute("tabindex", "-1");
                  link.classList.add("disabled");
                  link.addEventListener("click", e => e.preventDefault());
                }
              });
            });
    });
});
</script>


{% endblock %}
