{% extends 'case_officer/case_officer_dashboard_base1.html'%}
{% load static %}
{% block title%}| Welcome {% endblock %}

{% block styles %}



{% endblock %}


{% block content %}

<div class="col-xl-9">
<div class="card pb-3">
<div class="card-body">
<div class="d-flex justify-content-between align-items-center mb-3">
<h4 class="card-title text-info">Finalize Applications</h4>
</div>

<table id="datatable" class="table table-bordered dt-responsive">
    <thead class="table-light">
      <tr>
        <th>Ref No</th>
        <th>Client</th>
        <th>Email</th>
        <th>Country</th>
        <th>Visa Type</th>
        <th>Status</th>
        <th>Created On</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>


<div class="d-flex justify-content-end"> 
<a href="{% url 'CaseManagement:case_officer_dashboard' %}" class="btn btn-soft-success mt-4"><i class="bx bxs-log-out align-middle me-1"></i> Return to Dashboard</a>`
</div>
</div>
</div>
<!--end col-->
</div><!--end row-->


</div> <!-- container-fluid -->
</div>





<!-- Application Detail Modal -->
<div class="modal fade" id="applicationDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-success">Finalize Applications</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="application-detail-content">
        <p class="text-muted">Select an application to finalize.</p>
      </div>
    </div>
  </div>
</div>

<!-- jQuery (must come first) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>



<script>
$(document).ready(function () {
    // üîπ Initialize DataTable
    let table = $('#datatable').DataTable({
        ajax: {
            url: "/api/applications/submitted_list_view/",
            dataSrc: ""
        },
        rowId: row => `row-${row.id}`, // ‚úÖ make each row selectable by ID
        columns: [
            { data: "reference_no" },
            { data: "client_name" },
            { data: "client_email" },
            { data: "country_display" },
            { data: "visa_type_display" },
            {
                data: "status_display",
                render: function (data, type, row) {
                    return `<span class="badge ${row.status_badge}" id="application-status-badge-${row.id}">
                              ${data}
                            </span>`;
                }
            },
            {
                data: "created_at",
                render: function (data) {
                    return data ? data : "-";
                }
            },
            {
                data: "id",
                render: function (id) {
                    return `<button type="button"
                              class="btn btn-primary btn-sm btn-rounded view-details-btn"
                              data-id="${id}"
                              data-bs-toggle="modal"
                              data-bs-target="#applicationDetailModal">
                              View Details
                            </button>`;
                }
            }
        ],
        pageLength: 10,
        responsive: true,
        ordering: true
    });

    // üîπ Handle "View Details" button click
    $('#datatable tbody').on('click', '.view-details-btn', function () {
        let appId = $(this).data('id');
        let modalBody = document.querySelector("#applicationDetailModal #application-detail-content");

        modalBody.innerHTML = "<p class='text-muted'>Loading...</p>";

        fetch(`/api/applications/${appId}/`)
            .then(res => res.json())
            .then(app => {
                let officerRow = "";
                if (app.created_by_officer_name) {
                    officerRow = `<tr><th>Initiating Officer</th><td>${app.created_by_officer_name}</td></tr>`;
                } else if (app.assigned_officer_name) {
                    officerRow = `<tr><th>Assigned Officer</th><td>${app.assigned_officer_name}</td></tr>`;
                } else {
                    officerRow = `<tr><th>Officer</th><td>-</td></tr>`;
                }
                let detailsHtml = `
                    <h5 class="text-info">Application Info</h5>
                    <table class="table table-bordered">
                      <tr><th>Reference</th><td>${app.reference_no}</td></tr>
                      <tr><th>Client</th><td>${app.client_name}</td></tr>
                      <tr><th>Email</th><td>${app.client_email}</td></tr>
                      <tr><th>Passport No</th><td>${app.passport_number}</td></tr>
                      <tr><th>Country</th><td>${app.country_display}</td></tr>
                      <tr><th>Visa Type</th><td>${app.visa_type_display}</td></tr>
                      <tr><th>Status</th>
                        <td><span id="application-status-badge" class="badge ${app.status_badge}">
                          ${app.status_display}
                        </span></td>
                      </tr>
                      ${officerRow}
                      <tr><th>Created On</th><td>${app.created_at ?? '-'}</td></tr>
                      <tr><th>Visa Application URL</th>
                        <td>${app.visa_application_url 
                            ? `<a href="${app.visa_application_url}" target="_blank">${app.visa_application_url}</a>
                               <a href="${app.visa_application_url}" target="_blank" class="btn btn-sm btn-soft-success ms-2">Go To URL</a>` 
                            : '<em>No URL added yet</em>'}
                        </td>
                      </tr>
                      <tr><th>Submission Date</th><td>${app.submission_date ?? '-'}</td></tr>
                      <tr><th>Decision Date</th><td><span id="application-decision-date">${app.decision_date ?? '-'}</span></td></tr>
                      <tr><th>Rejection Letter</th>
                        <td id="rejection-letter-cell">
                          ${app.rejection_letter ? `<a href="${app.rejection_letter}" target="_blank">View</a>` : '-'}
                        </td>
                      </tr>
                    </table>
                `;
                 modalBody.innerHTML = detailsHtml;

                if (app.status === "SUBMITTED") {
                    detailsHtml += `
                      <div class="mt-3 text-end">
                        <select id="decision-select-${app.id}" class="form-select d-inline w-auto me-2">
                          <option value="">-- Select Decision --</option>
                          <option value="APPROVED">‚úÖ Approved</option>
                          <option value="REJECTED">‚ùå Rejected</option>
                        </select>
                        <button class="btn btn-primary" id="add-decision-btn" data-id="${app.id}">
                          Save Decision
                        </button>
                      </div>`;
                } else {
                    detailsHtml += `
                      <div class="mt-3 text-end">
                        <button class="btn btn-secondary" disabled>
                          Decision Already Made
                        </button>
                      </div>`;
                }

                // Append documents section
              let docsHtml = `
                <h5 class="mt-4 text-info">Documents</h5>
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Requirement</th>
                      <th>Status</th>
                      <th>File</th>
                      <th>Comments</th>
                      <th>Uploaded</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
              `;


                if (app.documents.length === 0) {
                    docsHtml += `<tr><td colspan="6" class="text-center text-muted">No documents uploaded yet.</td></tr>`;
                } else {
                    app.documents.forEach(doc => {
                        docsHtml += `
                          <tr>
                            <td>${doc.requirement_name}</td>
                            <td><span class="badge ${doc.status_badge}">${doc.status_display}</span></td>
                            <td>${doc.file ? `<a href="${doc.file}" target="_blank">View</a>` : '-'}</td>
                            <td>
                              <input type="text" class="form-control form-control-sm review-comment-input"
                                     data-doc-id="${doc.id}"
                                     value="${doc.review_comments ?? ''}"
                                     placeholder="Add comment"
                                     ${doc.status === "REVIEWED" ? "readonly" : ""}>
                            </td>
                            <td>${doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleString() : '-'}</td>
                            <td>
                              ${doc.status === "REVIEWED"
                                ? `<span class="text-success">‚úÖ Reviewed</span>`
                                : `<button class="btn btn-sm btn-success review-btn" data-id="${doc.id}">Mark Reviewed</button>`}
                            </td>
                          </tr>
                        `;
                    });
                }

                docsHtml += "</tbody></table>"
                ;

            // === Refusal Letters table ===
            let refusalsHtml = `
                <h5 class="mt-4 text-danger">Previous Refusal Letters</h5>
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>File</th>
                      <th>Uploaded</th>
                    </tr>
                  </thead>
                  <tbody>
            `;

            if (!app.refusal_letters || app.refusal_letters.length === 0) {
                refusalsHtml += `<tr><td colspan="2" class="text-center text-muted">No refusal letters uploaded.</td></tr>`;
            } else {
                app.refusal_letters.forEach(ref => {
                    refusalsHtml += `
                        <tr>
                          <td><a href="${ref.file}" target="_blank">View Refusal Letter</a></td>
                          <td>${ref.uploaded_at ? new Date(ref.uploaded_at).toLocaleString() : '-'}</td>
                        </tr>
                    `;
                });
            }
            refusalsHtml += "</tbody></table>";

            modalBody.innerHTML = detailsHtml + docsHtml + refusalsHtml;
            });
    });

    // üîπ Handle document review button
    document.body.addEventListener("click", function (e) {
        if (e.target.closest(".review-btn")) {
            let btn = e.target.closest(".review-btn");
            let docId = btn.dataset.id;
            let commentInput = document.querySelector(`.review-comment-input[data-doc-id="${docId}"]`);
            let comments = commentInput ? commentInput.value : "";

            fetch(`/api/documents/${docId}/review/`, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: JSON.stringify({ review_comments: comments })
            })
            .then(res => res.json())
            .then(updatedDoc => {
                // Update row in modal
                let row = btn.closest("tr");
                let statusCell = row.querySelector("td:nth-child(2) span");
                if (statusCell) {
                    statusCell.textContent = updatedDoc.status_display;
                    statusCell.className = "badge " + updatedDoc.status_badge;
                }

                btn.outerHTML = `<span class="text-success">‚úÖ Reviewed</span>`;
                if (commentInput) {
                    commentInput.value = updatedDoc.review_comments ?? "";
                    commentInput.setAttribute("readonly", "readonly");
                }

                // Update badges in modal + main table
                fetch(`/api/applications/${updatedDoc.application}/`)
                    .then(r => r.json())
                    .then(updatedApp => {
                        const badgeEl = document.getElementById("application-status-badge");
                        if (badgeEl) {
                            badgeEl.textContent = updatedApp.status_display;
                            badgeEl.className = "badge " + updatedApp.status_badge;
                        }

                        const tableBadgeEl = document.getElementById(`application-status-badge-${updatedApp.id}`);
                        if (tableBadgeEl) {
                            tableBadgeEl.textContent = updatedApp.status_display;
                            tableBadgeEl.className = "badge " + updatedApp.status_badge;
                        }
                    });
            });
        }
    });

    // üîπ Handle Add Decision button
    document.body.addEventListener("click", function (e) {
        if (e.target.closest("#add-decision-btn")) {
            let btn = e.target.closest("#add-decision-btn");
            let appId = btn.dataset.id;
            let select = document.getElementById(`decision-select-${appId}`);
            if (!select || !select.value) {
                alert("Please select APPROVED or REJECTED first.");
                return;
            }
            let decision = select.value;

            if (!confirm(`Are you sure you want to mark this application as ${decision}?`)) return;

            fetch(`/api/applications/${appId}/add_decision/`, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: JSON.stringify({ status: decision })
            })
            .then(res => res.json())
            .then(updatedApp => {
                // ‚úÖ Update modal badge
                const modalBadge = document.getElementById("application-status-badge");
                if (modalBadge) {
                    modalBadge.textContent = updatedApp.status_display;
                    modalBadge.className = "badge " + updatedApp.status_badge;
                }

                // ‚úÖ Replace controls
                if (select) select.disabled = true;
                btn.outerHTML = `<button class="btn btn-secondary" disabled>
                                    ‚úÖ Decision Recorded: ${updatedApp.status_display}
                                 </button>`;

                // ‚úÖ Update table badge
                const tableBadgeEl = document.getElementById(`application-status-badge-${updatedApp.id}`);
                if (tableBadgeEl) {
                    tableBadgeEl.textContent = updatedApp.status_display;
                    tableBadgeEl.className = "badge " + updatedApp.status_badge;
                }

                // ‚úÖ Update decision date
                const decisionDateEl = document.getElementById("application-decision-date");
                if (decisionDateEl) decisionDateEl.textContent = updatedApp.decision_date ?? '-';

                // ‚úÖ If REJECTED ‚Üí show upload form
                if (decision === "REJECTED") {
                    let modalBody = document.querySelector("#applicationDetailModal #application-detail-content");
                    modalBody.insertAdjacentHTML("beforeend", `
                        <div class="mt-4 p-3 border rounded bg-light">
                            <h6 class="text-danger">Upload Rejection Letter</h6>
                            <input type="file" id="rejection-file-${updatedApp.id}" class="form-control mb-2">
                            <button class="btn btn-danger" id="upload-rejection-btn" data-id="${updatedApp.id}">
                                Upload Letter
                            </button>
                        </div>
                    `);
                }

                // ‚úÖ Update DataTable row directly
                let row = table.row(`#row-${updatedApp.id}`);
                if (row) {
                    row.data(updatedApp).draw(false);
                }

                alert(`Application has been ${updatedApp.status_display}`);
            })
            .catch(err => console.error("Error updating decision:", err));
        }
    });

    // üîπ Handle rejection letter upload
    document.body.addEventListener("click", function (e) {
        if (e.target.closest("#upload-rejection-btn")) {
            let btn = e.target.closest("#upload-rejection-btn");
            let appId = btn.dataset.id;
            let fileInput = document.getElementById(`rejection-file-${appId}`);
            if (!fileInput || !fileInput.files.length) {
                alert("Please select a file first.");
                return;
            }

            let formData = new FormData();
            formData.append("rejection_letter", fileInput.files[0]);

            fetch(`/api/applications/${appId}/add_decision/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: formData
            })
            .then(res => res.json())
            .then(updatedApp => {
                // ‚úÖ Remove upload form
                btn.parentElement.innerHTML = `
                        <p class="text-success mb-2">Rejection letter uploaded successfully.</p>
                    `;

                // ‚úÖ Update modal cell
                let rejectionCell = document.querySelector("#rejection-letter-cell");
                if (rejectionCell) {
                    rejectionCell.innerHTML = updatedApp.rejection_letter
                        ? `<a href="${updatedApp.rejection_letter}" target="_blank">View</a>` : "-";
                }

                // ‚úÖ Update DataTable row
                let row = table.row(`#row-${updatedApp.id}`);
                if (row) {
                    row.data(updatedApp).draw(false);
                }
            })
            .catch(err => console.error("Error uploading rejection letter:", err));
        }
    });

    // üîπ CSRF Helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>


{% endblock %}
