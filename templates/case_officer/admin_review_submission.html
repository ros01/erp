{% extends 'case_officer/case_officer_dashboard_base1.html'%}
{% load static %}
{% block title%}| Welcome {% endblock %}

{% block styles %}

{% endblock %}

{% block content %}
<div class="col-xl-9">
<div class="card pb-3">
<div class="card-body">

<h4 class="card-title text-info mb-4">Reviewed Applications</h4>
<div class="table-responsive">
<table id="datatable" class="table table-bordered dt-responsive">
<thead class="table-light">
<tr>
<th class="align-middle">Ref No:</th>
<th class="align-middle">Name</th>
<th class="align-middle">Email</th>
<th class="align-middle">Country</th>
<th class="align-middle">Type</th>
<th class="align-middle">Status</th>
<th class="align-middle">Date</th>
<th class="align-middle">Action</th>
</tr>
</thead>

<tbody id="datatable-tbody">
<tr>
<td colspan="8" class="text-center text-muted">Loading applications...</td>
</tr>
</tbody>

</table>
</div>

<div class="d-flex justify-content-end"> 
<a href="{% url 'CaseManagement:case_officer_dashboard' %}" class="btn btn-soft-primary py-1 mr-4 mt-4"><i class="bx bxs-log-out align-middle me-1"></i> Return to Dashboard</a>`
</div>
</div>
</div>
<!--end col-->
</div><!--end row-->


</div> <!-- container-fluid -->
</div>


<!-- Application Detail Modal -->
<div class="modal fade" id="applicationDetailModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-lg modal-dialog-scrollable">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title text-success">Add Visa Application URL for Admin Review</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body" id="application-detail-content">
<p class="text-muted">Add Visa Application URL for Admin Review</p>
</div>
</div>
</div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function () {
// ðŸ”¹ Initialize DataTable
window.table = $('#datatable').DataTable({
ajax: {
    url: "/api/applications/reviewed/",
    dataSrc: "" // change to "results" if API wraps results
},
order: [[5, "desc"]], // column index of "Date"
columns: [
    { data: "reference_no" },
    { data: "client_name" },
    { data: "client_email" },
    { data: "country_display" },
    { data: "visa_type_display" },
    {
        data: "status_display",
        render: function (data, type, row) {
            return `<span class="badge ${row.status_badge}" id="status-badge-${row.id}">
                      ${data}
                    </span>`;
        },
        className: "status-cell"
    },
    {
        data: "created_at",
        render: function (data) {
            return data ? data : "-";   // âœ… fallback to '-' if null/empty
        }
    },
    {
        data: "id",
        render: function (id) {
            return `<button type="button"
                      class="btn btn-primary btn-sm btn-rounded view-details-btn"
                      data-id="${id}"
                      data-bs-toggle="modal"
                      data-bs-target="#applicationDetailModal">
                      View Details
                    </button>`;
        }
    }
],
createdRow: function (row, data) {
    // ðŸ”¹ add data-id for easy lookup later
    $(row).attr("data-id", data.id);
},
pageLength: 10,
responsive: true,
ordering: true
});
});

// ðŸ”¹ Handle "View Details" button click
$('#datatable tbody').on('click', '.view-details-btn', function () {
    let appId = $(this).data('id');
    let modalBody = document.querySelector("#applicationDetailModal #application-detail-content");

    modalBody.innerHTML = "<p class='text-muted'>Loading...</p>";

    fetch(`/api/applications/${appId}/`)
        .then(res => res.json())
        .then(app => {
            // âœ… Officer row logic with fallback
            let officerRow = "";
            if (app.created_by_officer_name) {
                officerRow = `
                    <tr>
                        <th>Initiating Officer</th>
                        <td>${app.created_by_officer_name ?? '-'}</td>
                    </tr>
                `;
            } else if (app.assigned_officer_name) {
                officerRow = `
                    <tr>
                        <th>Assigned Officer</th>
                        <td>${app.assigned_officer_name ?? '-'}</td>
                    </tr>
                `;
            } else {
                officerRow = `
                    <tr>
                        <th>Officer</th>
                        <td>-</td>
                    </tr>
                `;
            }

// âœ… Only include Rejection Letter row if present
// let rejectionLetterRow = "";
// if (app.rejection_letter) {
//     rejectionLetterRow = `
//         <tr>
//             <th>Rejection Letter</th>
//             <td><a href="${app.rejection_letter}" target="_blank">View Letter</a></td>
//         </tr>
//     `;
// }


let detailsHtml = `
    <h5 class="text-info">Application Info</h5>
    <table class="table table-bordered">
      <tr><th>Reference</th><td>${app.reference_no}</td></tr>
      <tr><th>Client</th><td>${app.client_name}</td></tr>
      <tr><th>Email</th><td>${app.client_email}</td></tr>
    <tr><th>Passport No</th><td>${app.passport_number}</td></tr>
      <tr><th>Country</th><td>${app.country_display}</td></tr>
      <tr><th>Visa Type</th><td>${app.visa_type_display}</td></tr>
      <tr><th>Status</th>
        <td><span id="application-status-badge" class="badge ${app.status_badge}">
          ${app.status_display}
        </span></td>

      </tr>
      ${officerRow}
      <tr><th>Created On</th><td>${app.created_at ?? '-'}</td></tr>
      <tr>
        <th>Visa Application URL</th>
        <td>
            <span id="visa-url-display">${app.visa_application_url ?? '-'}</span>
            <input type="url" id="visa-url-input" class="form-control form-control-sm mt-2" placeholder="Enter Visa URL">
            <button type="button" class="btn btn-sm btn-success mt-2" id="add-url-btn" data-id="${app.id}">
              Add Visa Application URL
            </button>
          </td>
      </tr>

      <tr><th>Submission Date</th><td id="submission-date-cell">${app.submission_date ?? '-'}</td></tr>
      <tr><th>Decision Date</th><td>${app.decision_date ?? '-'}</td></tr>
     
     <tr>
      <th>Rejection Letters</th>
      <td id="rejection-letter-cell">
        ${
          Array.isArray(app.rejection_letters) && app.rejection_letters.length
            ? app.rejection_letters
                .map((r, i) =>
                  r?.file
                    ? `
                      <div class="mb-1">
                        <span class="badge bg-danger me-2">
                          Letter ${i + 1}
                        </span>
                        <a href="${r.file}"
                           target="_blank"
                           rel="noopener noreferrer">
                          View Rejection Letter
                        </a>
                      </div>
                    `
                    : ""
                )
                .join("") || "-"
            : "-"
        }
      </td>
      </tr>


    </table>
`;

// ðŸ”¹ Documents section
// let docsHtml = `
//     <h5 class="mt-4 text-info">Documents</h5>
//     <table class="table table-striped">
//       <thead>
//         <tr>
//           <th>Requirement</th>
//           <th>Status</th>
//           <th>File</th>
//           <th>Comments</th>
//           <th>Uploaded</th>
//           <th>Action</th>
//         </tr>
//       </thead>
//       <tbody>
// `;

// if (app.documents.length === 0) {
//     docsHtml += `<tr><td colspan="6" class="text-center text-muted">No documents uploaded yet.</td></tr>`;
// } else {
//     app.documents.forEach(doc => {
//         docsHtml += `
//             <tr>
//               <td>${doc.requirement_name}</td>
//               <td><span class="badge ${doc.status_badge}">${doc.status_display}</span></td>
//               <td>${doc.file ? `<a href="${doc.file}" target="_blank">View</a>` : '-'}</td>
//               <td>
//                 <input type="text" class="form-control form-control-sm review-comment-input"
//                        data-doc-id="${doc.id}"
//                        value="${doc.review_comments ?? ''}"
//                        placeholder="Add comment"
//                        ${doc.status === "REVIEWED" ? "readonly" : ""}>
//               </td>
//               <td>${doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleString() : '-'}</td>
//               <td>
//                 ${doc.status === "REVIEWED"
//                   ? `<span class="text-success">âœ… Reviewed</span>`
//                   : `<button class="btn btn-sm btn-success review-btn" data-id="${doc.id}">Mark Reviewed</button>`}
//               </td>
//             </tr>
//         `;
//     });
// }

// docsHtml += "</tbody></table>";

//ðŸ”¹ Documents section
let docsHtml = `<h5 class="mt-4 text-info">Documents</h5>`;

// ===============================
// ðŸŽ“ STUDENT VISA â†’ STAGED VIEW
// ===============================
if (app.visa_type === "STUDENT") {

  const stages = ["ADMISSION", "CAS", "VISA"];
  const stageLabels = {
    ADMISSION: "Admission",
    CAS: "CAS",
    VISA: "Visa Application"
  };

  // Group documents by stage
  let grouped = {};
  stages.forEach(s => grouped[s] = []);

  app.documents.forEach(doc => {
    if (grouped[doc.stage]) {
      grouped[doc.stage].push(doc);
    }
  });

  // Tabs header
  docsHtml += `
    <ul class="nav nav-tabs mt-3" role="tablist">
      ${stages.map((stage, i) => `
        <li class="nav-item">
          <button class="nav-link ${i === 0 ? "active" : ""}"
                  data-bs-toggle="tab"
                  data-bs-target="#stage-${stage}">
            ${stageLabels[stage]}
          </button>
        </li>
      `).join("")}
    </ul>
  `;

  // Tabs content
  docsHtml += `<div class="tab-content border border-top-0 p-3">`;

  stages.forEach((stage, i) => {
    docsHtml += `
      <div class="tab-pane fade ${i === 0 ? "show active" : ""}"
           id="stage-${stage}">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Requirement</th>
              <th>Status</th>
              <th>File</th>
              <th>Comments</th>
              <th>Uploaded</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
    `;

    if (grouped[stage].length === 0) {
      docsHtml += `
        <tr>
          <td colspan="5" class="text-center text-muted">
            No documents for this stage.
          </td>
        </tr>
      `;
    } else {
      grouped[stage].forEach(doc => {
        docsHtml += `
          <tr>
            <td>${doc.requirement_name}</td>
            <td><span class="badge ${doc.status_badge}">
              ${doc.status_display}
            </span></td>
            <td>${doc.file ? `<a href="${doc.file}" target="_blank">View</a>` : "-"}</td>
            <td>${doc.review_comments ?? "-"}</td>
            <td>${doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleString() : "-"}</td>
            <td>
                ${doc.status === "REVIEWED"
                  ? `<span class="text-success">âœ… Reviewed</span>`
                  : `<button class="btn btn-sm btn-success review-btn" data-id="${doc.id}">Mark Reviewed</button>`}
              </td>
          </tr>
        `;
      });
    }

    docsHtml += `</tbody></table></div>`;
  });

  docsHtml += `</div>`; // end tab-content
}


// ===============================
// ðŸ§³ NON-STUDENT VISA â†’ FLAT VIEW
// ===============================
else {

docsHtml += `
<table class="table table-striped mt-3">
  <thead>
    <tr>
      <th>Requirement</th>
      <th>Status</th>
      <th>File</th>
      <th>Comments</th>
      <th>Uploaded</th>
     <th>Action</th>
    </tr>
  </thead>
  <tbody>
`;

if (app.documents.length === 0) {
docsHtml += `
  <tr>
    <td colspan="5" class="text-center text-muted">
      No documents uploaded yet.
    </td>
  </tr>
`;
} else {
app.documents.forEach(doc => {
  docsHtml += `
    <tr>
      <td>${doc.requirement_name}</td>
      <td><span class="badge ${doc.status_badge}">
        ${doc.status_display}
      </span></td>
      <td>${doc.file ? `<a href="${doc.file}" target="_blank">View</a>` : "-"}</td>
      <td>${doc.review_comments ?? "-"}</td>
      <td>${doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleString() : "-"}</td>

<td>
${doc.status === "REVIEWED"
  ? `<span class="text-success">âœ… Reviewed</span>`
  : `<button class="btn btn-sm btn-success review-btn" data-id="${doc.id}">Mark Reviewed</button>`}
</td>


    </tr>
  `;
});
}

docsHtml += `</tbody></table>`;
}




// === Refusal Letters table ===
// let refusalsHtml = `
// <h5 class="mt-4 text-danger">Previous Refusal Letters</h5>
// <table class="table table-striped">
// <thead>
// <tr>
// <th>File</th>
// <th>Uploaded</th>
// </tr>
// </thead>
// <tbody>
// `;

// if (!app.refusal_letters || app.refusal_letters.length === 0) {
//     refusalsHtml += `<tr><td colspan="2" class="text-center text-muted">No refusal letters uploaded.</td></tr>`;
// } else {
//     app.refusal_letters.forEach(ref => {
//         refusalsHtml += `
//             <tr>
//               <td><a href="${ref.file}" target="_blank">View Refusal Letter</a></td>
//               <td>${ref.uploaded_at ? new Date(ref.uploaded_at).toLocaleString() : '-'}</td>
//             </tr>
//         `;
//     });
// }
// refusalsHtml += "</tbody></table>";
// modalBody.innerHTML = detailsHtml + docsHtml + refusalsHtml;
modalBody.innerHTML = detailsHtml + docsHtml;
});
});

// === Visa URL PATCH + Status Update ===
document.body.addEventListener("click", function (e) {
  if (e.target.id === "add-url-btn") {
    let appId = e.target.dataset.id;
    let newUrl = document.querySelector("#visa-url-input").value;

    fetch(`/api/applications/${appId}/add-url/`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify({ visa_application_url: newUrl }),
    })
    .then(res => res.json())
    .then(data => {
      // âœ… Update Visa URL in modal
      document.querySelector("#visa-url-display").textContent = data.visa_application_url;

      // âœ… Update modal status badge
      const modalStatusBadge = document.querySelector("#application-status-badge");
      modalStatusBadge.textContent = data.status_display;
      modalStatusBadge.className = "badge " + data.status_badge;

      // âœ… Update table row using DataTables API
      let row = table.row(`[data-id="${data.id}"]`);
      if (row) {
        let rowData = row.data();
        rowData.status = data.status;
        rowData.status_display = data.status_display;
        rowData.status_badge = data.status_badge;
        rowData.visa_application_url = data.visa_application_url;
        row.data(rowData).invalidate().draw(false);
      }
    })
    .catch(err => {
      console.error("Error updating visa URL:", err);
    });
  }
});

// === Helper: Get CSRF Token ===
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>




{% endblock %}
