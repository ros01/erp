{% extends 'clients/clients_dashboard_base1.html'%}
{% load static %}
{% block title%}| Welcome {% endblock %}

{% block styles %}



{% endblock %}


{% block content %}


<div class="col-xl-9">
<div class="card pb-3">
<div class="card-body">
<div class="d-flex justify-content-between align-items-center mb-3">
<!-- <h2>Visa Application Documents</h2> -->
<h4 class="card-title text-info mb-2">Visa Application Documents</h4>
<!-- <button id="refreshBtn" class="btn btn-outline-secondary btn-sm">üîÑ Refresh Checklist</button> -->
</div>

<table id="datatable" class="table table-bordered dt-responsive  nowrap w-100">
<thead class="table-light">
<tr>
<th>Requirement</th>
<th>Status</th>
<th>Upload / View</th>
</tr>
</thead>
<tbody id="documentsBody">
{% for doc in application.documents.all %}

<tr data-doc-id="{{ doc.id }}">
<td>{{ doc.requirement.name }}</td>
<td class="status">
<span class="badge 
{% if doc.status == 'MISSING' %} bg-danger 
{% elif doc.status == 'REJECTED' %} bg-warning 
{% elif doc.status == 'APPROVED' or doc.status == 'UPLOADED' %} bg-success 
{% else %} bg-secondary {% endif %}">
{{ doc.status }}
</span>
</td>
<td class="action-cell">
{% if doc.file %}
<a href="{{ doc.file.url }}" target="_blank" class="btn btn-soft-success"><i class="bx bxs-folder-open align-middle me-1"></i> View File</a>
<!-- <a href="{{ doc.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">View</a> -->
{% elif doc.status == "MISSING" or doc.status == "REJECTED" %}
<div class="d-flex gap-2">
<input type="file" class="form-control form-control-sm file-input" />
<button class="btn btn-sm btn-primary upload-btn">Upload</button>
</div>
{% else %}
<span class="text-muted">‚Äî</span>
{% endif %}
</td>
</tr>
{% empty %}
<tr>
<td colspan="3" class="text-center">No required documents found.</td>
</tr>
{% endfor %}







</tbody>
</table>




<div class="d-flex justify-content-end"> 
<!-- <a href="{{request.META.HTTP_REFERER}}" class="btn btn-soft-success mt-4 mr-3"><i class="fas fa-angle-double-left"></i> Go Back</a>  -->

<a href="{% url 'Clients:applications-list' %}" class="btn btn-soft-success mt-4 mr-3"><i class="fas fa-angle-double-left"></i>  Return to Applications</a>`
</div>



</div>
<!--end col-->
</div><!--end row-->

</div> <!-- container-fluid -->
</div> 
</div>
<!-- End Page-content -->
<!-- </div> -->

<!-- Refusal Modal -->
<div class="modal fade" id="refusalModal" tabindex="-1" aria-labelledby="refusalModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="refusalModalLabel">Visa Refusal History</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Have you ever been refused a visa before?</p>
        <div class="d-flex gap-2 mt-3">
          <button id="refusalYesBtn" class="btn btn-danger">Yes</button>
          <button id="refusalNoBtn" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
        </div>

        <!-- Hidden upload section -->
        <div id="refusalUploadSection" class="mt-4 d-none">
          <label for="refusalFile" class="form-label">Upload Previous Refusal Letter(s)</label>
          <input type="file" id="refusalFile" class="form-control" multiple>
          <button id="uploadRefusalBtn" class="btn btn-primary mt-2">Upload</button>
          <div id="refusalUploadStatus" class="mt-2 small text-muted"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// --- CSRF helper ---
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie("csrftoken");

// --- Upload handler ---
document.addEventListener("click", async (e) => {
  if (!e.target.classList.contains("upload-btn")) return;

  const row = e.target.closest("tr");
  const docId = row.dataset.docId;
  const fileInput = row.querySelector(".file-input");

  if (!fileInput || !fileInput.files.length) {
    alert("Please choose a file first.");
    return;
  }

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);

  try {
    const res = await fetch(`/api/documents/${docId}/upload/`, {
      method: "POST",
      body: formData,
      headers: { "X-CSRFToken": csrftoken },
      credentials: "include"
    });

    const contentType = res.headers.get("content-type") || "";
    if (!res.ok) {
      const errorText = await res.text();
      alert(`Upload failed (${res.status}): ${
        contentType.includes("application/json")
          ? JSON.parse(errorText).detail || "Unknown error"
          : errorText.slice(0, 200)
      }`);
      return;
    }

    if (contentType.includes("application/json")) {
      const data = await res.json();

      // update status cell
      row.querySelector(".status").innerHTML =
        `<span class="badge bg-success">${data.status}</span>`;

      // update action cell to show "View"
      row.querySelector(".action-cell").innerHTML =
        `<a href="${data.file_url}" target="_blank" class="btn btn-soft-success"><i class="bx bxs-folder-open align-middle me-1"></i> View File</a>`;
    } else {
      alert("Upload succeeded but server did not return JSON.");
    }
  } catch (err) {
    console.error("Upload error:", err);
    alert("Upload failed due to network or server error.");
  }
});

// --- Refresh Checklist (prevents duplication) ---
document.getElementById("refreshBtn").addEventListener("click", async () => {
  try {
    const res = await fetch(window.location.href, { headers: { "X-Requested-With": "XMLHttpRequest" } });
    if (!res.ok) throw new Error("Failed to refresh");
    const html = await res.text();

    // parse and extract only tbody
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");
    const newBody = doc.querySelector("#documentsBody");
    document.querySelector("#documentsBody").innerHTML = newBody.innerHTML;
  } catch (err) {
    console.error("Refresh error:", err);
    alert("Could not refresh documents.");
  }
});

  function allDocumentsUploaded() {
    const rows = document.querySelectorAll("#documentsBody tr");
    return Array.from(rows).every(row => {
      const status = row.querySelector(".status span");
      return status && status.innerText.trim().toUpperCase() === "UPLOADED";
    });
  }

  async function handleUploadSuccess(row, data) {
    row.querySelector(".status").innerHTML =
      `<span class="badge bg-success">${data.status}</span>`;

    row.querySelector(".action-cell").innerHTML =
      `<a href="${data.file_url}" target="_blank" class="btn btn-soft-success"><i class="bx bxs-folder-open align-middle me-1"></i> View File</a>`;

    if (allDocumentsUploaded()) {
      const refusalModal = document.getElementById("refusalModal");
      if (refusalModal) {
        let modalInstance = new bootstrap.Modal(refusalModal);
        modalInstance.show();
      }
    }
  }

  // Show upload section if user clicks "Yes"
  const refusalYesBtn = document.getElementById("refusalYesBtn");
  if (refusalYesBtn) {
    refusalYesBtn.addEventListener("click", () => {
      const section = document.getElementById("refusalUploadSection");
      if (section) section.classList.remove("d-none");
    });
  }

  // Upload refusal letters
  uploadRefusalBtn.addEventListener("click", async () => {
      const applicationId = "{{ application.id }}";
      const filesInput = document.getElementById("refusalFile");
      if (!filesInput || !filesInput.files.length) {
        alert("Please select at least one file.");
        return;
      }

      const formData = new FormData();
      for (let i = 0; i < filesInput.files.length; i++) {
        formData.append("refusal_files", filesInput.files[i]);
      }

      try {
        const res = await fetch(`/api/applications/${applicationId}/upload-refusals/`, {
          method: "POST",
          body: formData,
          headers: { "X-CSRFToken": csrftoken },
          credentials: "include"
        });

        const text = await res.text(); // raw response
        console.log("Upload status:", res.status, "body:", text);

        if (!res.ok) {
          document.getElementById("refusalUploadStatus").innerHTML =
            `<span class="text-danger">‚ùå Upload failed (status ${res.status}).</span>`;
          return;
        }

        const data = JSON.parse(text);
        document.getElementById("refusalUploadStatus").innerHTML =
          `<span class="text-success">‚úÖ Uploaded ${data.files_uploaded} refusal letter(s).</span>`;
      } catch (err) {
        console.error("Upload error:", err);
        document.getElementById("refusalUploadStatus").innerHTML =
          `<span class="text-danger">‚ùå Upload failed. Please try again.</span>`;
      }
    });


  // Example: upload via #refusalFilesInput (extra block you had)
  const refusalFilesInput = document.querySelector("#refusalFilesInput");
  if (refusalFilesInput) {
    let formData = new FormData();
    let files = refusalFilesInput.files;
    for (let i = 0; i < files.length; i++) {
      formData.append("refusal_files", files[i]);
    }

    fetch(`/api/applications/${appId}/refusal-letters/`, {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": getCookie("csrftoken")
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        console.log("Uploaded refusal letters:", data.refusal_letters);
      }
    });
  }



</script>
{% endblock %}