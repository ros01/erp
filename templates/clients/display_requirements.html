{% extends 'clients/clients_dashboard_base1.html'%}
{% load static %}
{% block title%}| Welcome {% endblock %}

{% block styles %}



{% endblock %}


{% block content %}


<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->

<style>
    :root { --c:#1f2937; --m:#6b7280; --b:#2563eb; --bg:#f8fafc; --card:#ffffff; }
    body{margin:0;background:var(--bg);color:var(--c);font-family:system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:880px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 12px} p{color:var(--m);margin:0 0 18px}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;padding:18px}
    label{font-weight:600;display:block;margin:10px 0 6px}
    select{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    button{background:var(--b);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    button[disabled]{opacity:0.5;cursor:not-allowed}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .reqs{margin-top:16px}
    .req{display:flex;justify-content:space-between;align-items:center;border:1px solid #e5e7eb;border-radius:10px;padding:10px;margin-bottom:8px;background:#fff}
    .tag{font-size:12px;border-radius:999px;padding:4px 8px;border:1px solid #e5e7eb;color:var(--m)}
    .tag.req{border-color:#ef4444;color:#ef4444}
    .tag.opt{border-color:#6b7280}
    .muted{color:var(--m)}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid #e5e7eb;border-top-color:var(--b);border-radius:50%;animation:spin 1s linear infinite;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:680px){.row{grid-template-columns:1fr}}
  </style>


<div class="col-xl-9">
    <div class="card">
        <div class="card-body border-bottom">
            <div class="d-flex">
                <!-- <img src="assets/images/companies/wechat.svg" alt="" height="50">
                <div class="flex-grow-1 ms-3"> -->
                    <h5 class="fw-semibold text-info">Start Your Visa Application</h5>
                    <!-- <ul class="list-unstyled hstack gap-2 mb-0">
                        <li>
                            <i class="bx bx-building-house"></i> <span class="text-muted">Themesbrand</span>
                        </li>
                        <li>
                            <i class="bx bx-map"></i> <span class="text-muted">California</span>
                        </li>
                    </ul> -->
                <!-- </div> -->
            </div>
        </div>
        <div class="card-body">
            <h5 class="fw-semibold mb-3">Description</h5>
            <p class="text-muted">Select a <strong>country</strong> and <strong>visa type</strong> to preview requirements. Then confirm to start your application.</p>
            
			<div class="row2">
			<div>
			<label for="country">Country of Interest</label>
			<select id="country">
			<option value="">â€” Select country â€”</option>
			</select>
			</div>
			<div>
			<label for="visaType">Visa Type</label>
			<select id="visaType" disabled>
			<option value="">â€” Select visa type â€”</option>
			</select>
			</div>
			</div>

			<div style="margin-top:14px;display:flex;gap:10px;align-items:center">
			<button id="showBtn" type="button" disabled>Show Requirements</button>
			<span id="status" class="muted" aria-live="polite"></span>
			</div>

			<div class="reqs" id="requirements" aria-live="polite"></div>

			<!-- Confirm Application button -->
			<div class="d-flex justify-content-end pr-4" style="margin-top:20px">
			<button id="confirmBtn" type="button" disabled>âœ… Confirm & Start Application</button>

			</div>




			<div id="appResult" class="reqs"></div>


           

            <!-- <div class="mt-4">
                <span class="badge badge-soft-warning">PHP</span>
                <span class="badge badge-soft-warning">Magento</span>
                <span class="badge badge-soft-warning">Marketing</span>
                <span class="badge badge-soft-warning">WordPress</span>
                <span class="badge badge-soft-warning">Bootstrap</span>
            </div> -->

            <!-- <div class="mt-4">
                <ul class="list-inline mb-0">
                    <li class="list-inline-item mt-1">
                        Share this job:
                    </li>
                    <li class="list-inline-item mt-1">
                        <a href="javascript:void(0)" class="btn btn-outline-primary btn-hover"><i class="uil uil-facebook-f"></i> Facebook</a>
                    </li>
                    <li class="list-inline-item mt-1">
                        <a href="javascript:void(0)" class="btn btn-outline-danger btn-hover"><i class="uil uil-google"></i> Google+</a>
                    </li>
                    <li class="list-inline-item mt-1">
                        <a href="javascript:void(0)" class="btn btn-outline-success btn-hover"><i class="uil uil-linkedin-alt"></i> linkedin</a>
                    </li>
                </ul>
            </div> -->



        </div>
    </div>
</div><!--end col-->
</div><!--end row-->

</div> <!-- container-fluid -->

<!-- </div>  -->
<!-- End Page-content -->
<!-- </div> -->

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      // Does this cookie string begin with the name we want?
      if (cookie.substring(0, name.length + 1) === (name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie("csrftoken");
</script>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const API_BASE = "/api";
  const countrySel = document.getElementById("country");
  const visaSel = document.getElementById("visaType");
  const showBtn = document.getElementById("showBtn");
  const confirmBtn = document.getElementById("confirmBtn");
  const reqsEl = document.getElementById("requirements");
  const appResultEl = document.getElementById("appResult");

  let currentUser = null;
  let userIsLoggedIn = false;

  // --- CSRF helper ---
  // function getCSRFToken() {
  //   const match = document.cookie.match(/(^|;)\\s*csrftoken=([^;]+)/);
  //   return match ? decodeURIComponent(match[2]) : "";
  // }

    function getCSRFToken() {
    const match = document.cookie.match(/(^|;)\s*csrftoken=([^;]+)/);
    return match ? decodeURIComponent(match[2]) : "";
  }


  // --- JSON fetch wrapper with CSRF + credentials ---
  async function fetchJSON(url, opts = {}) {
    const res = await fetch(url, {
      headers: { 
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken(),
        ...opts.headers
      },
      credentials: "include",
      method: opts.method || "GET",
      body: opts.body ? JSON.stringify(opts.body) : undefined
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
    return res.json();
  }

  function resetVisaTypes(disabled = true) {
    visaSel.innerHTML = `<option value="">â€” Select visa type â€”</option>`;
    visaSel.disabled = disabled;
  }

  function resetRequirements() {
    reqsEl.innerHTML = "";
    confirmBtn.disabled = true;
  }

  // ðŸŸ¢ Fetch current user info
  async function checkLoginStatus() {
    try {
      currentUser = await fetchJSON(`${API_BASE}/user/`);
      userIsLoggedIn = !!currentUser;
      console.log("User logged in:", currentUser);
    } catch {
      currentUser = null;
      userIsLoggedIn = false;
      console.log("No logged-in user.");
    }
  }

  // ðŸŸ¢ Load countries
  (async function loadCountries() {
    try {
      await checkLoginStatus();
      const countries = await fetchJSON(`${API_BASE}/countries/`);
      countries.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.code;
        opt.textContent = c.name;
        countrySel.appendChild(opt);
      });
    } catch (e) { console.error("Countries load failed", e); }
  })();

  // ðŸŸ¢ Country â†’ visa types
  countrySel.addEventListener("change", async () => {
    resetVisaTypes();
    resetRequirements();
    const country = countrySel.value;
    if (!country) { resetVisaTypes(true); return; }
    try {
      const visaTypes = await fetchJSON(`${API_BASE}/visa-types/?country=${encodeURIComponent(country)}`);
      visaTypes.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.code;
        opt.textContent = v.name;
        visaSel.appendChild(opt);
      });
      visaSel.disabled = false;
    } catch (e) { console.error("Visa types load failed", e); }
  });

  visaSel.addEventListener("change", () => {
    showBtn.disabled = !(countrySel.value && visaSel.value);
    resetRequirements();
  });

  // ðŸŸ¢ Show requirements with inline PDF download
  showBtn.addEventListener("click", async () => {
    resetRequirements();
    const country = countrySel.value;
    const visa = visaSel.value;
    if (!country || !visa) return;

    try {
      const reqs = await fetchJSON(`${API_BASE}/requirements/?country=${encodeURIComponent(country)}&visa_type=${encodeURIComponent(visa)}`);
      if (!reqs.length) {
        reqsEl.innerHTML = "<div class='muted'>No requirements found.</div>";
        return;
      }

      reqs.forEach(r => {
        const row = document.createElement("div");
        row.className = "req";

        let pdfLink = "";
        if (r.form_file_url) {
          // Auto-fill if logged in, else static link
          const pdfUrl = currentUser
            ? `${API_BASE}/pdf-form-fill/?country=${encodeURIComponent(country)}&visa_type=${encodeURIComponent(visa)}`
            : r.form_file_url;

          pdfLink = `<a href="${pdfUrl}" target="_blank" class="btn btn-sm btn-outline-danger flash-button" style="margin-left:10px">
                       <i class="bx bxs-file-pdf align-middle me-1"></i> Download Form
                     </a>`;
        }

        row.innerHTML = `
          <div>
            <strong>${r.name}</strong><br/>
            <small class="muted">${r.description || "â€”"}</small>
          </div>
          ${pdfLink}
          <div style="display:flex;align-items:center;gap:10px;">
            <span class="tag ${r.is_mandatory ? "req" : "opt"}">
              ${r.is_mandatory ? "Required" : "Optional"}
            </span>
          </div>
        `;
        reqsEl.appendChild(row);
      });

      confirmBtn.disabled = false;

    } catch (e) {
      console.error("Requirements fetch failed", e);
    }
  });

  // ðŸŸ¢ Confirm Application
  const applicationDocumentsUrl = "{{ application_documents_url }}";
  confirmBtn.addEventListener("click", async () => {
    const country = countrySel.value;
    const visa = visaSel.value;

    const sure = confirm(`Are you sure you want to start a ${visa} visa application for ${country}?`);
    if (!sure) return;

    try {
      const app = await fetchJSON(`${API_BASE}/applications/new/`, {
        method: "POST",
        body: { country, visa_type: visa }
      });

      appResultEl.innerHTML = `<div class="alert alert-success">
        Application submitted successfully!<br/>
        Reference: <strong>${app.reference_no}</strong>
      </div>`;

      setTimeout(() => {
        const redirectUrl = applicationDocumentsUrl.replace("{pk}", app.id);
        window.location.href = redirectUrl;
      }, 1500);

    } catch (e) {
      alert("Failed to create application. Are you logged in?");
      console.error("Application create failed", e);
    }
  });
});
</script>

<style>
/* ðŸŸ¡ Bright flashing yellow effect for Download PDF */
.flash-yellow {
  animation: flashYellow 1s infinite;
  border: 2px solid gold;
  box-shadow: 0 0 10px gold;
}

@keyframes flashYellow {
  0% { background-color: gold; color: black; }
  50% { background-color: #ffea00; color: #111; box-shadow: 0 0 25px yellow; }
  100% { background-color: gold; color: black; }
}
</style>



<!-- ðŸš« Prevent DataTables auto-initialization -->
<!-- <script>
  window.addEventListener("DOMContentLoaded", () => {
    if (window.jQuery && jQuery.fn.dataTable) {
      jQuery.fn.dataTable = function() {
        console.warn("DataTables initialization blocked on this page.");
        return this; // noop
      };
    }
  });
</script>  -->




{% endblock %}