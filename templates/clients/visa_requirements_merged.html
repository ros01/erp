{% extends 'clients/clients_dashboard_base1.html' %}
{% load static %}
{% load dict_extras %}

{% block title %}| Application Documents{% endblock %}

{% block content %}

<style>
.stage-advance {
  animation: slidePulse 1.2s ease-in-out;
}

@keyframes slidePulse {
  0% { opacity: 0; transform: translateX(40px); }
  60% { opacity: 1; transform: translateX(-5px); }
  100% { transform: translateX(0); }
}
</style>

<div class="col-xl-9">
<div class="card pb-3">
<div class="card-body">

<h4 class="card-title text-info mb-3">
  {{ application.country }} Visa Application Documents
  (Ref: {{ application.reference_no }})
</h4>

{% if application.visa_type == "STUDENT" %}
  {# ===================================================== #}
  {# üéì STUDENT VISA ‚Äî STAGE-BASED UI #}
  {# ===================================================== #}

  <h6 class="text-info mb-2">Visa Application Stages</h6>

  <div class="mb-4 d-flex align-items-center flex-wrap gap-2 stage-timeline">
    {% for stage in stage_sequence %}
      <span class="badge
        {% if stage == current_stage %}
          bg-success
        {% elif stage in completed_stages %}
          bg-primary
        {% else %}
          bg-secondary
        {% endif %}
      ">
        {{ stage|title }}
      </span>
      {% if not forloop.last %}<span>‚Üí</span>{% endif %}
    {% endfor %}
  </div>

  <h6 class="text-info mb-3 current-stage-heading">
    {{ current_stage|title }} Stage Documents
  </h6>

  {% include "clients/partials/document_table.html" with documents=documents %}

{% else %}
  {# ===================================================== #}
  {# üß≥ NON-STUDENT VISA ‚Äî LEGACY FLAT UI #}
  {# ===================================================== #}

  <h6 class="text-info mb-3">Required Documents</h6>

  {% include "clients/partials/document_table.html" with documents=application.documents.all %}

{% endif %}

<div class="d-flex justify-content-end mt-4">
  <a href="{% url 'Clients:applications-list' %}" class="btn btn-soft-secondary">
    ‚Üê Back to Applications
  </a>
</div>

</div>
</div>
</div>






<!-- Refusal Modal -->
<div class="modal fade" id="refusalModal" tabindex="-1" aria-labelledby="refusalModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="refusalModalLabel">Visa Refusal History</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Have you ever been refused a visa before?</p>
        <div class="d-flex gap-2 mt-3">
          <button id="refusalYesBtn" class="btn btn-danger">Yes</button>
          <button id="refusalNoBtn" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
        </div>

        <!-- Hidden upload section -->
        <div id="refusalUploadSection" class="mt-4 d-none">
          <label for="refusalFile" class="form-label">Upload Previous Refusal Letter(s)</label>
          <input type="file" id="refusalFile" class="form-control" multiple>
          <button id="uploadRefusalBtn" class="btn btn-primary mt-2">Upload</button>
          <div id="refusalUploadStatus" class="mt-2 small text-muted"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// --- CSRF helper ---
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie("csrftoken");

// --- Upload handler ---
document.addEventListener("click", async (e) => {
  if (!e.target.classList.contains("upload-btn")) return;

  const row = e.target.closest("tr");
  const docId = row.dataset.docId;
  const fileInput = row.querySelector(".file-input");

  if (!fileInput || !fileInput.files.length) {
    alert("Please choose a file first.");
    return;
  }

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);

  try {
    const res = await fetch(`/api/documents/${docId}/upload/`, {
      method: "POST",
      body: formData,
      headers: { "X-CSRFToken": csrftoken },
      credentials: "include"
    });

    const contentType = res.headers.get("content-type") || "";
    if (!res.ok) {
      const errorText = await res.text();
      alert(`Upload failed (${res.status}): ${
        contentType.includes("application/json")
          ? JSON.parse(errorText).detail || "Unknown error"
          : errorText.slice(0, 200)
      }`);
      return;
    }

    if (contentType.includes("application/json")) {
      const data = await res.json();

      handleUploadSuccess(row, data);

    } else {
      alert("Upload succeeded but server did not return JSON.");
    }
  } catch (err) {
    console.error("Upload error:", err);
    alert("Upload failed due to network or server error.");
  }
});

// --- Refresh Checklist (prevents duplication) ---
document.getElementById("refreshBtn").addEventListener("click", async () => {
  try {
    const res = await fetch(window.location.href, { headers: { "X-Requested-With": "XMLHttpRequest" } });
    if (!res.ok) throw new Error("Failed to refresh");
    const html = await res.text();

    // parse and extract only tbody
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");
    const newBody = doc.querySelector("#documentsBody");
    document.querySelector("#documentsBody").innerHTML = newBody.innerHTML;
  } catch (err) {
    console.error("Refresh error:", err);
    alert("Could not refresh documents.");
  }
});

  function allDocumentsUploaded() {
    const rows = document.querySelectorAll("#documentsBody tr");
    return Array.from(rows).every(row => {
      const status = row.querySelector(".status span");
      return status && status.innerText.trim().toUpperCase() === "UPLOADED";
    });
  }


// async function handleUploadSuccess(row, data) {
//   // Update row UI
//   row.querySelector(".status").innerHTML =
//     `<span class="badge bg-success">UPLOADED</span>`;

//   row.querySelector(".action-cell").innerHTML =
//     `<a href="${data.file_url}" target="_blank"
//         class="btn btn-soft-success">
//         <i class="bx bxs-folder-open me-1"></i> View File
//      </a>`;

//   if (data.stage_advanced === true) {
//   showStageAdvance(data.new_stage, data.progress);
// }

// if (data.final_stage_completed === true) {
//   showFinalVisaCompletion();
// }
// }


async function handleUploadSuccess(row, data) {
  row.querySelector(".status").innerHTML =
    `<span class="badge bg-success">UPLOADED</span>`;

  row.querySelector(".action-cell").innerHTML =
    `<a href="${data.file_url}" target="_blank"
        class="btn btn-soft-success">
        <i class="bx bxs-folder-open me-1"></i> View File
     </a>`;

  const visaType = "{{ application.visa_type }}";

  // üéì STUDENT VISA FLOW
  if (visaType === "STUDENT") {
    if (data.stage_advanced === true) {
      showStageAdvance(data.new_stage, data.progress);
    }

    if (data.final_stage_completed === true) {
      showFinalVisaCompletion();
    }
  }

  // üß≥ NON-STUDENT VISA FLOW
  else {
    if (data.final_stage_completed === true) {
      showNonStudentCompletion();
    }
  }
}



async function reloadStageUI() {
  console.log("üîÑ Reloading stage UI");

  const res = await fetch(window.location.href, {
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });

  if (!res.ok) {
    console.error("‚ùå Failed to reload stage UI");
    return;
  }

  const html = await res.text();
  const temp = document.createElement("div");
  temp.innerHTML = html;

  // üîÅ Replace stage badges
  const newStageBlock = temp.querySelector(".stage-timeline");
  const oldStageBlock = document.querySelector(".stage-timeline");
  if (newStageBlock && oldStageBlock) {
    oldStageBlock.replaceWith(newStageBlock);
  }

  // üîÅ Replace stage heading
  const newHeading = temp.querySelector(".current-stage-heading");
  const oldHeading = document.querySelector(".current-stage-heading");
  if (newHeading && oldHeading) {
    oldHeading.replaceWith(newHeading);
  }

  // üîÅ Replace documents table
  const newTable = temp.querySelector("table");
  const oldTable = document.querySelector("table");
  if (newTable && oldTable) {
    oldTable.replaceWith(newTable);
  }

  console.log("‚úÖ Stage UI updated");
}



function showStageAdvance(newStage, progress) {
  console.log("üéâ Stage auto-advanced to:", newStage);

  const container = document.querySelector(".card-body");

  const banner = document.createElement("div");
  banner.className = "alert alert-info mt-3 stage-advance";
  banner.innerHTML = `
    üéâ <strong>Stage advanced!</strong>
    <div class="mt-1">
      You are now in <strong>${newStage}</strong> stage.
    </div>
    <div class="progress mt-2">
      <div class="progress-bar bg-success"
           style="width:${progress}%">
        ${progress}%
      </div>
    </div>
  `;

  container.prepend(banner);

  // ‚è≥ Auto-refresh stage UI + documents
  setTimeout(async () => {
    await reloadStageUI();
    banner.remove();
  }, 7200);
}



function showFinalVisaCompletion() {
  const container = document.querySelector(".card-body");

  const banner = document.createElement("div");
  banner.className = "alert alert-success mt-3 stage-advance";
  banner.innerHTML = `
    üéâ <strong>Documents upload complete!</strong>
    <div class="mt-2">
      Your student visa application documents upload is complete.<br>
      <strong>You have now been assigned to a case officer.</strong>
    </div>

    <div class="progress mt-3">
      <div class="progress-bar bg-success progress-bar-striped progress-bar-animated"
           style="width:100%">
        100%
      </div>
    </div>
  `;

  container.prepend(banner);

  // ‚è≥ Redirect after animation
  setTimeout(() => {
    window.location.href = "/Clients/applications/";
  }, 7200);
}



function showNonStudentCompletion() {
  const container = document.querySelector(".card-body");

  const banner = document.createElement("div");
  banner.className = "alert alert-success mt-3 stage-advance";
  banner.innerHTML = `
    üéâ <strong>Documents submitted successfully!</strong>
    <div class="mt-2">
      You have successfully submitted all required documents.<br>
      <strong>Your application has been assigned to a case officer.</strong>
    </div>

    <div class="progress mt-3">
      <div class="progress-bar bg-success progress-bar-striped progress-bar-animated"
           style="width:100%">
        100%
      </div>
    </div>
  `;

  container.prepend(banner);

  setTimeout(() => {
    window.location.href = "/Clients/applications/";
  }, 7200);
}


function closeStageBanner() {
  const banner = document.getElementById("stageAdvanceBanner");
  if (banner) banner.remove();
}


  // Show upload section if user clicks "Yes"
  const refusalYesBtn = document.getElementById("refusalYesBtn");
  if (refusalYesBtn) {
    refusalYesBtn.addEventListener("click", () => {
      const section = document.getElementById("refusalUploadSection");
      if (section) section.classList.remove("d-none");
    });
  }

  // Upload refusal letters
  uploadRefusalBtn.addEventListener("click", async () => {
      const applicationId = "{{ application.id }}";
      const filesInput = document.getElementById("refusalFile");
      if (!filesInput || !filesInput.files.length) {
        alert("Please select at least one file.");
        return;
      }

      const formData = new FormData();
      for (let i = 0; i < filesInput.files.length; i++) {
        formData.append("refusal_files", filesInput.files[i]);
      }

      try {
        const res = await fetch(`/api/applications/${applicationId}/upload-refusals/`, {
          method: "POST",
          body: formData,
          headers: { "X-CSRFToken": csrftoken },
          credentials: "include"
        });

        const text = await res.text(); // raw response
        console.log("Upload status:", res.status, "body:", text);

        if (!res.ok) {
          document.getElementById("refusalUploadStatus").innerHTML =
            `<span class="text-danger">‚ùå Upload failed (status ${res.status}).</span>`;
          return;
        }

        const data = JSON.parse(text);
        document.getElementById("refusalUploadStatus").innerHTML =
          `<span class="text-success">‚úÖ Uploaded ${data.files_uploaded} refusal letter(s).</span>`;
      } catch (err) {
        console.error("Upload error:", err);
        document.getElementById("refusalUploadStatus").innerHTML =
          `<span class="text-danger">‚ùå Upload failed. Please try again.</span>`;
      }
    });


  // Example: upload via #refusalFilesInput (extra block you had)
  const refusalFilesInput = document.querySelector("#refusalFilesInput");
  if (refusalFilesInput) {
    let formData = new FormData();
    let files = refusalFilesInput.files;
    for (let i = 0; i < files.length; i++) {
      formData.append("refusal_files", files[i]);
    }

    fetch(`/api/applications/${appId}/refusal-letters/`, {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": getCookie("csrftoken")
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        console.log("Uploaded refusal letters:", data.refusal_letters);
      }
    });
  }





</script>
{% endblock %}