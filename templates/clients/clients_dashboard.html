{% extends 'clients/clients_dashboard_base.html'%}
{% load static %}
{% block title%}| Welcome {% endblock %}

{% block styles %}


{% endblock %}


{% block content %}

<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="main-content">

<div class="page-content">
<div class="container-fluid">

<div class="row">
<div class="col-xl-4">
<div class="card overflow-hidden">
<div class="bg-primary-subtle">
<div class="row">
<div class="col-7">
<div class="text-primary p-3">
<h5 class="text-primary">Welcome !</h5>
<p>Clients Dashboard</p>
</div>
</div>
<div class="col-5 align-self-end">
<img src="{% static 'admin_assets/images/profile-img.png' %}" alt="" class="img-fluid">
</div>
</div>
</div>
<div class="card-body pt-0">
<div class="row">
<div class="col-sm-4">
<div class="avatar-md profile-user-wid mb-4">
<img src="{% static 'admin_assets/images/users/avatar-1.jpg' %}" alt="" class="img-thumbnail rounded-circle">
</div>
<h5 class="font-size-15 text-truncate">{{user.get_full_name}}</h5>
<p class="text-muted mb-0 text-truncate">Visa Applicant</p>
</div>

<div class="col-sm-8">
<div class="pt-4">

<div class="row">
<div class="col-6">
<h5 class="font-size-15">{{ approved_count }}</h5>
<p class="text-muted mb-0">Approved</p>
</div>
<div class="col-6">
<h5 class="font-size-15">{{ rejected_count }}</h5>
<p class="text-muted mb-0">Rejected</p>
</div>
</div>
<div class="mt-4">
<a href="javascript: void(0);" class="btn btn-primary waves-effect waves-light btn-sm">View Profile <i class="mdi mdi-arrow-right ms-1"></i></a>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="card">
<div class="card-body">
<h4 class="card-title mb-3">Personal Information</h4>
<div class="table-responsive">
<table class="table table-nowrap mb-0">
<tbody>
<tr>
<th scope="row">Full Name :</th>
<td>{{user.get_full_name}}</td>
</tr>
<tr>
<th scope="row">Mobile :</th>
<td>{{user.phone}}</td>
</tr>
<tr>
<th scope="row">E-mail :</th>
<td>{{user.email}}</td>
</tr>
<tr>
<th scope="row">Address :</th>
<td>{{ user.client_profile.address }}</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


</div>
<div class="col-xl-8">
<div class="row">
<div class="col-md-4">
<div class="card mini-stats-wid">
<div class="card-body">
<div class="d-flex">
<div class="flex-grow-1">
<p class="text-muted fw-medium">Total Applications</p>
<h4 class="mb-0">{{ applications_count }}</h4>
</div>

<div class="flex-shrink-0 align-self-center">
<div class="mini-stat-icon avatar-sm rounded-circle bg-primary">
<span class="avatar-title">
<i class="bx bx-copy-alt font-size-24"></i>
</span>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="col-md-4">
<div class="card mini-stats-wid">
<div class="card-body">
<div class="d-flex">
<div class="flex-grow-1">
<p class="text-muted fw-medium">Pending Applications</p>
<h4 class="mb-0">{{ pending_count }}</h4>
</div>

<div class="flex-shrink-0 align-self-center">
<div class="avatar-sm rounded-circle bg-primary mini-stat-icon">
<span class="avatar-title rounded-circle bg-primary">
<i class="bx bx-archive-in font-size-24"></i>
</span>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="col-md-4">
<div class="card mini-stats-wid">
<div class="card-body">
<div class="d-flex">
<div class="flex-grow-1">
<p class="text-muted fw-medium">Completed Applications</p>
<h4 class="mb-0">{{ completed_count }}</h4>
</div>

<div class="flex-shrink-0 align-self-center">
<div class="avatar-sm rounded-circle bg-primary mini-stat-icon">
<span class="avatar-title rounded-circle bg-primary">
<i class="bx bx-purchase-tag-alt font-size-24"></i>
</span>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- end row -->


<div class="row">
<div class="col-lg-12">
<div class="card">
<div class="card-body">

<div class="col-sm-12">
<div class="text-sm-end">

<a href="{% url 'Clients:start-application' %}" class="btn btn-primary btn-rounded waves-effect waves-light addContact-modal mb-2"> New Visa Application</a>


</div>
</div><!-- end col-->

<h4 class="card-title mb-4">Latest Applications</h4>
<div class="table-responsive">
    <table id="datatable" class="table table-bordered dt-responsive">
        <thead class="table-light">
            <tr>
                <th>Ref No:</th>
                <th>Country</th>
                <th>Type</th>
                <th>Status</th>
                <th>Date</th>
                <th>View Details</th>
            </tr>
        </thead>
        <tbody id="datatable-tbody">
            <tr>
                <td colspan="5" class="text-center text-muted">Loading...</td>
            </tr>
        </tbody>
    </table>
</div>
  <!-- end table-responsive -->
</div>
</div>
</div>
</div>
<!-- end row -->
                            
</div>
</div>
<!-- end row -->

</div> <!-- container-fluid -->
</div>
<!-- End Page-content -->
</div>


<!-- Application Detail Modal -->
<div class="modal fade" id="applicationDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-success">Application Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="application-detail-content">
        <p class="text-muted">Select an application to view details.</p>
      </div>
    </div>
  </div>
</div>

<!-- jQuery (must come first) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function () {
    // ðŸ”¹ Initialize DataTable
    let table = $('#datatable').DataTable({
        ajax: {
            url: "/api/applications/",
            dataSrc: "" // change to "results" if API wraps results
        },
        order: [[3, "desc"]], // column index of "Created On / Date"
        columns: [
            { data: "reference_no" },
            { data: "country_display" },
            // { data: "client_email" },
            { data: "visa_type_display" },
            {
                data: "status_display",
                render: function (data, type, row) {
                    return `<span class="badge ${row.status_badge}" id="application-status-badge-${row.id}">
                              ${data}
                            </span>`;
                }
            },
            {
                data: "created_at",
                render: function (data, type, row) {
                    return data ? data : "-";   // âœ… fallback to '-' if null/empty
                }
            },
            {
                data: "id",
                render: function (id, type, row) {
                    return `<button type="button"
                              class="btn btn-primary btn-sm btn-rounded view-details-btn"
                              data-id="${id}"
                              data-bs-toggle="modal"
                              data-bs-target="#applicationDetailModal">
                              View Details
                            </button>`;
                }
            }
        ],
        pageLength: 10,
        responsive: true,
        ordering: true
    });

    // ðŸ”¹ Handle View Details button clicks
    $('#datatable').on('click', '.view-details-btn', function () {
        let appId = $(this).data('id');
        let modalBody = document.querySelector("#applicationDetailModal #application-detail-content");
        modalBody.innerHTML = "<p class='text-muted'>Loading...</p>";

        fetch(`/api/applications/${appId}/`)
            .then(res => res.json())
            .then(app => {
                // âœ… Officer row logic with fallback
                let officerRow = "";
                if (app.created_by_officer_name) {
                    officerRow = `
                        <tr>
                            <th>Initiating Officer</th>
                            <td>${app.created_by_officer_name ?? '-'}</td>
                        </tr>
                    `;
                } else if (app.assigned_officer_name) {
                    officerRow = `
                        <tr>
                            <th>Assigned Officer</th>
                            <td>${app.assigned_officer_name ?? '-'}</td>
                        </tr>
                    `;
                } else {
                    officerRow = `
                        <tr>
                            <th>Officer</th>
                            <td>-</td>
                        </tr>
                    `;
                }
                let detailsHtml = `
                  <h5 class="text-info">Application Info</h5>
                  <table class="table table-bordered">
                    <tr><th>Reference</th><td>${app.reference_no}</td></tr>
                    <tr><th>Country</th><td>${app.country_display}</td></tr>
                    <tr><th>Visa Type</th><td>${app.visa_type_display}</td></tr>
                    <tr><th>Status</th><td><span class="badge ${app.status_badge}">${app.status_display}</span></td></tr>
                     ${officerRow}
                    <tr><th>Created On</th><td>${app.created_at ?? '-'}</td></tr>
                  <tr>
                    <tr><th>Visa Application URL</th>
                        <td>
                          ${app.visa_application_url 
                            ? `<a href="${app.visa_application_url}" target="_blank">${app.visa_application_url}</a>
                               <a href="${app.visa_application_url}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">Go To URL</a>` 
                            : '-'}
                        </td>
                    </tr>
                    <tr><th>Submission Date</th><td>${app.submission_date ?? '-'}</td></tr>
                    <tr><th>Decision Date</th><td>${app.decision_date ?? '-'}</td></tr>

                    <tr>
                      <th>Rejection Letters</th>
                      <td id="rejection-letter-cell">
                        ${
                          Array.isArray(app.rejection_letters) && app.rejection_letters.length
                            ? app.rejection_letters
                                .map((r, i) =>
                                  r?.file
                                    ? `
                                      <div class="mb-1">
                                        <span class="badge bg-danger me-2">
                                          Letter ${i + 1}
                                        </span>
                                        <a href="${r.file}"
                                           target="_blank"
                                           rel="noopener noreferrer">
                                          View Rejection Letter
                                        </a>
                                      </div>
                                    `
                                    : ""
                                )
                                .join("") || "-"
                            : "-"
                        }
                      </td>
                      </tr>
                  </table>
                `;

                // let docsHtml = `
                //   <h5 class="mt-4 text-info">Documents</h5>
                //   <table class="table table-striped">
                //     <thead>
                //       <tr>
                //         <th>Requirement</th>
                //         <th>Status</th>
                //         <th>File</th>
                //         <th>Comments</th>
                //         <th>Uploaded</th>
                //       </tr>
                //     </thead>
                //     <tbody>
                // `;


let docsHtml = `<h5 class="mt-4 text-info">Documents</h5>`;

// ===============================
// ðŸŽ“ STUDENT VISA â†’ STAGED VIEW
// ===============================
if (app.visa_type === "STUDENT") {

  const stages = ["ADMISSION", "CAS", "VISA"];
  const stageLabels = {
    ADMISSION: "Admission",
    CAS: "CAS",
    VISA: "Visa Application"
  };

  // Group documents by stage
  let grouped = {};
  stages.forEach(s => grouped[s] = []);

  app.documents.forEach(doc => {
    if (grouped[doc.stage]) {
      grouped[doc.stage].push(doc);
    }
  });

  // Tabs header
  docsHtml += `
    <ul class="nav nav-tabs mt-3" role="tablist">
      ${stages.map((stage, i) => `
        <li class="nav-item">
          <button class="nav-link ${i === 0 ? "active" : ""}"
                  data-bs-toggle="tab"
                  data-bs-target="#stage-${stage}">
            ${stageLabels[stage]}
          </button>
        </li>
      `).join("")}
    </ul>
  `;

  // Tabs content
  docsHtml += `<div class="tab-content border border-top-0 p-3">`;

  stages.forEach((stage, i) => {
    docsHtml += `
      <div class="tab-pane fade ${i === 0 ? "show active" : ""}"
           id="stage-${stage}">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Requirement</th>
              <th>Status</th>
              <th>File</th>
              <th>Comments</th>
              <th>Uploaded</th>
            </tr>
          </thead>
          <tbody>
    `;

    if (grouped[stage].length === 0) {
      docsHtml += `
        <tr>
          <td colspan="5" class="text-center text-muted">
            No documents for this stage.
          </td>
        </tr>
      `;
    } else {
      grouped[stage].forEach(doc => {
        docsHtml += `
          <tr>
            <td>${doc.requirement_name}</td>
            <td><span class="badge ${doc.status_badge}">
              ${doc.status_display}
            </span></td>
            <td>${doc.file ? `<a href="${doc.file}" target="_blank">View</a>` : "-"}</td>
            <td>${doc.review_comments ?? "-"}</td>
            <td>${doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleString() : "-"}</td>
          </tr>
        `;
      });
    }

    docsHtml += `</tbody></table></div>`;
  });

  docsHtml += `</div>`; // end tab-content
}


// ===============================
// ðŸ§³ NON-STUDENT VISA â†’ FLAT VIEW
// ===============================
else {

  docsHtml += `
    <table class="table table-striped mt-3">
      <thead>
        <tr>
          <th>Requirement</th>
          <th>Status</th>
          <th>File</th>
          <th>Comments</th>
          <th>Uploaded</th>
        </tr>
      </thead>
      <tbody>
  `;

  if (app.documents.length === 0) {
    docsHtml += `
      <tr>
        <td colspan="5" class="text-center text-muted">
          No documents uploaded yet.
        </td>
      </tr>
    `;
  } else {
    app.documents.forEach(doc => {
      docsHtml += `
        <tr>
          <td>${doc.requirement_name}</td>
          <td><span class="badge ${doc.status_badge}">
            ${doc.status_display}
          </span></td>
          <td>${doc.file ? `<a href="${doc.file}" target="_blank">View</a>` : "-"}</td>
          <td>${doc.review_comments ?? "-"}</td>
          <td>${doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleString() : "-"}</td>
        </tr>
      `;
    });
  }

  docsHtml += `</tbody></table>`;
}

                // if (app.documents.length === 0) {
                //     docsHtml += `<tr><td colspan="5" class="text-center text-muted">No documents uploaded yet.</td></tr>`;
                // } else {
                //     app.documents.forEach(doc => {
                //         docsHtml += `
                //           <tr>
                //             <td>${doc.requirement_name}</td>
                //             <td><span class="badge ${doc.status_badge}">${doc.status_display}</span></td>
                //             <td>${doc.file ? `<a href="${doc.file}" target="_blank">View</a>` : '-'}</td>
                //             <td>${doc.review_comments ?? '-'}</td>
                //             <td>${doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleString() : '-'}</td>
                //           </tr>
                //         `;
                //     });
                // }

                // docsHtml += "</tbody></table>";
                modalBody.innerHTML = detailsHtml + docsHtml;
            });
    });
});
</script>





{% endblock %}