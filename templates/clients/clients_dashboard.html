{% extends 'clients/clients_dashboard_base.html'%}
{% load static %}
{% block title%}| Welcome {% endblock %}

{% block styles %}


{% endblock %}


{% block content %}

<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<div class="main-content">

<div class="page-content">
<div class="container-fluid">

<div class="row">
<div class="col-xl-4">
<div class="card overflow-hidden">
<div class="bg-primary-subtle">
    <div class="row">
        <div class="col-7">
            <div class="text-primary p-3">
                <h5 class="text-primary">Welcome !</h5>
                <p>Clients Dashboard</p>
            </div>
        </div>
        <div class="col-5 align-self-end">
            <img src="{% static 'admin_assets/images/profile-img.png' %}" alt="" class="img-fluid">
        </div>
    </div>
</div>
<div class="card-body pt-0">
    <div class="row">
        <div class="col-sm-4">
            <div class="avatar-md profile-user-wid mb-4">
                <img src="{% static 'admin_assets/images/users/avatar-1.jpg' %}" alt="" class="img-thumbnail rounded-circle">
            </div>
            <h5 class="font-size-15 text-truncate">{{user.get_full_name}}</h5>
            <p class="text-muted mb-0 text-truncate">Visa Applicant</p>
        </div>

        <div class="col-sm-8">
            <div class="pt-4">

                <div class="row">
                    <div class="col-6">
                        <h5 class="font-size-15">5</h5>
                        <p class="text-muted mb-0">Applications</p>
                    </div>
                    <div class="col-6">
                        <h5 class="font-size-15">4</h5>
                        <p class="text-muted mb-0">Approvals</p>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="javascript: void(0);" class="btn btn-primary waves-effect waves-light btn-sm">View Profile <i class="mdi mdi-arrow-right ms-1"></i></a>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<div class="card">
<div class="card-body">
    <h4 class="card-title mb-3">Personal Information</h4>
    <div class="table-responsive">
        <table class="table table-nowrap mb-0">
            <tbody>
                <tr>
                    <th scope="row">Full Name :</th>
                    <td>{{user.get_full_name}}</td>
                </tr>
                <tr>
                    <th scope="row">Mobile :</th>
                    <td>{{user.phone}}</td>
                </tr>
                <tr>
                    <th scope="row">E-mail :</th>
                    <td>{{user.email}}</td>
                </tr>
                <tr>
                    <th scope="row">Address :</th>
                    <td>{{ user.client_profile.address }}</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
</div>


</div>
<div class="col-xl-8">
<div class="row">
<div class="col-md-4">
    <div class="card mini-stats-wid">
        <div class="card-body">
            <div class="d-flex">
                <div class="flex-grow-1">
                    <p class="text-muted fw-medium">Pending Reviews</p>
                    <h4 class="mb-0">3</h4>
                </div>

                <div class="flex-shrink-0 align-self-center">
                    <div class="mini-stat-icon avatar-sm rounded-circle bg-primary">
                        <span class="avatar-title">
                            <i class="bx bx-copy-alt font-size-24"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="col-md-4">
    <div class="card mini-stats-wid">
        <div class="card-body">
            <div class="d-flex">
                <div class="flex-grow-1">
                    <p class="text-muted fw-medium">Pending Applications</p>
                    <h4 class="mb-0">2</h4>
                </div>

                <div class="flex-shrink-0 align-self-center">
                    <div class="avatar-sm rounded-circle bg-primary mini-stat-icon">
                        <span class="avatar-title rounded-circle bg-primary">
                            <i class="bx bx-archive-in font-size-24"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="col-md-4">
    <div class="card mini-stats-wid">
        <div class="card-body">
            <div class="d-flex">
                <div class="flex-grow-1">
                    <p class="text-muted fw-medium">Completed Applications</p>
                    <h4 class="mb-0">1</h4>
                </div>

                <div class="flex-shrink-0 align-self-center">
                    <div class="avatar-sm rounded-circle bg-primary mini-stat-icon">
                        <span class="avatar-title rounded-circle bg-primary">
                            <i class="bx bx-purchase-tag-alt font-size-24"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<!-- end row -->


<div class="row">
<div class="col-lg-12">
<div class="card">
<div class="card-body">

<div class="col-sm-12">
<div class="text-sm-end">

<a href="{% url 'Clients:start-application' %}" class="btn btn-primary btn-rounded waves-effect waves-light addContact-modal mb-2"> New Visa Application</a>


</div>
</div><!-- end col-->

<h4 class="card-title mb-4">Latest Applications</h4>
<div class="table-responsive">
    <table class="table align-middle table-nowrap mb-0" id="applications-table">
        <thead class="table-light">
            <tr>
                <th></th>
                <th>Reference No:</th>
                <th>Type</th>
                <th>Status</th>
                <th>Date</th>
                <th>View Details</th>
            </tr>
        </thead>
        <tbody id="applications-body">
            <tr>
                <td colspan="6" class="text-center text-muted">Loading...</td>
            </tr>
        </tbody>
    </table>
</div>
  <!-- end table-responsive -->
</div>
</div>
</div>
</div>
<!-- end row -->
                            
</div>
</div>
<!-- end row -->

</div> <!-- container-fluid -->
</div>
<!-- End Page-content -->
</div>



<!-- Modal -->
<div class="modal fade" id="applicationDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-success">Application Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="application-detail-content">
          <p class="text-muted">Loading...</p>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
    let tbody = document.getElementById("applications-body");

    // Load applications
    fetch("/api/applications/")
        .then(response => response.json())
        .then(data => {
            tbody.innerHTML = "";

            if (data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='6' class='text-center text-muted'>No applications yet.</td></tr>";
                return;
            }

            data.forEach(app => {
                // Action cell: Upload Documents if pending, otherwise View Details
                // let actionCell;
                // if (app.status.toLowerCase() === "pending") {
                //     actionCell = `
                //         <a href="{% url 'Clients:application_documents' '00000000-0000-0000-0000-000000000000' %}"
                //            class="btn btn-warning btn-sm btn-rounded waves-effect waves-light upload-docs-btn"
                //            data-id="${app.id}">
                //             Upload Documents
                //         </a>`;
                // } else {
                //     actionCell = `
                //         <button type="button"
                //                 class="btn btn-primary btn-sm btn-rounded waves-effect waves-light view-details-btn"
                //                 data-id="${app.id}"
                //                 data-bs-toggle="modal"
                //                 data-bs-target="#applicationDetailModal">
                //             View Details
                //         </button>`;
                // }

                // Action cell: Upload Documents if there are missing docs, otherwise View Details
                let actionCell;
                let missingDocs = (app.documents || []).filter(doc => doc.status.toLowerCase() === "missing");

                if (missingDocs.length >= 1) {
                    actionCell = `
                        <a href="{% url 'Clients:application_documents' '00000000-0000-0000-0000-000000000000' %}"
                           class="btn btn-warning btn-sm btn-rounded waves-effect waves-light upload-docs-btn"
                           data-id="${app.id}">
                            Upload Documents
                        </a>`;
                } else {
                    actionCell = `
                        <button type="button"
                                class="btn btn-primary btn-sm btn-rounded waves-effect waves-light view-details-btn"
                                data-id="${app.id}"
                                data-bs-toggle="modal"
                                data-bs-target="#applicationDetailModal">
                            View Details
                        </button>`;
                }

                // Table row
                let row = `
                <tr>
                    <td>
                        <div class="form-check font-size-16">
                            <input class="form-check-input" type="checkbox">
                        </div>
                    </td>
                    <td><a href="javascript:void(0);" class="text-body fw-bold">${app.reference_no}</a></td>
                    <td>${app.visa_type}</td>
                   
                    <td><span class="badge ${app.status_badge}">${app.status_display}</span></td>

                    <td>${new Date(app.created_at).toLocaleDateString()}</td>
                    <td>${actionCell}</td>
                </tr>`;
                tbody.insertAdjacentHTML("beforeend", row);
            });

            // Fix all Upload Documents links with real app.id
            document.querySelectorAll(".upload-docs-btn").forEach(link => {
                let appId = link.dataset.id;
                link.href = "{% url 'Clients:application_documents' '00000000-0000-0000-0000-000000000000' %}"
                              .replace("00000000-0000-0000-0000-000000000000", appId);
            });
        });

    // Helper for status badge
    function renderStatus(status) {
        let badgeClass = "badge-soft-secondary";
        if (status.toLowerCase() === "approved") badgeClass = "badge-soft-success";
        else if (status.toLowerCase() === "rejected") badgeClass = "badge-soft-danger";
        else if ([
            "admin review","draft","documents submitted","form filled",
            "assigned to officer","submitted to embassy","under review","queued","pending"
        ].includes(status.toLowerCase())) {
            badgeClass = "badge-soft-warning";
        }
        return `<span class="badge badge-pill ${badgeClass} font-size-11">${status}</span>`;
    }

    // Handle View Details clicks
    document.body.addEventListener("click", function (e) {
        if (e.target.closest(".view-details-btn")) {
            let appId = e.target.closest(".view-details-btn").dataset.id;
            let modalBody = document.querySelector("#applicationDetailModal #application-detail-content");

            modalBody.innerHTML = "<p class='text-muted'>Loading...</p>";

            fetch(`/api/applications/${appId}/`)
                .then(res => res.json())
                .then(app => {
                    // Application details
                    let detailsHtml = `
                      <h5 class="text-info">Application Info</h5>
                      <table class="table table-bordered">
                        <tr><th>Reference</th><td>${app.reference_no}</td></tr>
                        <tr><th>Country</th><td>${app.country_display}</td></tr>
                        <tr><th>Visa Type</th><td>${app.visa_type_display}</td></tr>
                      
                        <tr><th>Status</th><td><span class="badge ${app.status_badge}">${app.status_display}</span></td></tr>
                        <tr><th>Assigned Officer</th><td>${app.assigned_officer_name ?? '-'}</td></tr>
                        <tr><th>Created At</th><td>${new Date(app.created_at).toLocaleString()}</td></tr>
                        <tr><th>Submission Date</th><td>${app.submission_date ?? '-'}</td></tr>
                        <tr><th>Decision Date</th><td>${app.decision_date ?? '-'}</td></tr>
                      </table>
                    `;

                    // Documents
                    let docsHtml = `
                      <h5 class="mt-4 text-info">Documents</h5>
                      <table class="table table-striped">
                        <thead>
                          <tr>
                            <th>Requirement</th>
                            <th>Status</th>
                            <th>File</th>
                            <th>Comments</th>
                            <th>Uploaded</th>
                          </tr>
                        </thead>
                        <tbody>
                    `;

                    if (app.documents.length === 0) {
                        docsHtml += `<tr><td colspan="5" class="text-center text-muted">No documents uploaded yet.</td></tr>`;
                    } else {
                        app.documents.forEach(doc => {
                            docsHtml += `
                              <tr>
                                <td>${doc.requirement_name}</td>
                                <td><span class="badge badge-pill ${doc.status_badge}">${doc.status_display}</span></td>
                                <td>${doc.file ? `<a href="${doc.file}" target="_blank">View</a>` : '-'}</td>
                                <td>${doc.review_comments ?? '-'}</td>
                                <td>${new Date(doc.uploaded_at).toLocaleString()}</td>
                              </tr>
                            `;
                        });
                    }

                    docsHtml += "</tbody></table>";
                    modalBody.innerHTML = detailsHtml + docsHtml;
                });
        }
    });
});
</script>

{% endblock %}