<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Visa Application - Client Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#f8fafc;margin:0}
    .wrap{max-width:500px;margin:40px auto;padding:20px;background:#fff;
          border-radius:10px;border:1px solid #ddd}
    h2,h3{margin-top:0}
    label{display:block;margin:10px 0 5px}
    input,select{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px}
    button{margin-top:15px;background:#2563eb;color:#fff;padding:10px 16px;
           border:0;border-radius:6px;cursor:pointer}
    .muted{color:#6b7280;font-size:14px;margin-top:10px}
  </style>
</head>
<body>
  <main class="main">
    <div class="container"> 
      <div class="wrap">
        <h3 class="text-warning">Register to Proceed</h3>
        <form id="registerForm">
          <meta name="csrf-token" content="{{ csrf_token }}"> 

          <label>First Name</label>
          <input type="text" id="regFirstName" required>

          <label>Last Name</label>
          <input type="text" id="regLastName" required>

          <label>Email</label>
          <input type="email" id="regEmail" required>

          <label>Phone</label>
          <input type="tel" id="regPhone" required placeholder="+2348012345678">

          <label>Password</label>
          <input type="password" id="regPassword" required>

          <label>Passport Number</label>
          <input type="text" id="regPassport" required>

          <label>Nationality</label>
          <select id="regNationality" required>
            <option value="">— Select nationality —</option>
          </select>

          <label>Date of Birth</label>
          <input type="date" id="regDOB" required>

          <label>Address</label>
          <input type="text" id="regAddress" required>

          <button type="submit">Register</button>
        </form>
        <div class="muted">Already have an account? <a href="/login/">Login here</a></div>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = "/api";

    // Handle form submit
    document.getElementById("registerForm").addEventListener("submit", async (e)=>{
      e.preventDefault();

      const payload = {
        user: {
          email: document.getElementById("regEmail").value,
          password: document.getElementById("regPassword").value,
          first_name: document.getElementById("regFirstName").value,
          last_name: document.getElementById("regLastName").value,
          phone: document.getElementById("regPhone").value,
          role: "Client"
        },
        passport_number: document.getElementById("regPassport").value,
        nationality: document.getElementById("regNationality").value,
        date_of_birth: document.getElementById("regDOB").value,
        address: document.getElementById("regAddress").value
      };

      try {
        const res = await fetch(`${API_BASE}/clients/register/`, {
          method: "POST",
          headers: {
            "Content-Type":"application/json",
            "X-CSRFToken": getCSRFToken()
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if(!res.ok){
          console.error("Registration error:", data);
          alert("Registration failed: " + JSON.stringify(data));
          return;
        }

        alert("Registration successful! Please log in.");
        window.location.href = "/login/";
      } catch (err) {
        console.error("Network/JS error:", err);
        alert("Something went wrong: " + err.message);
      }
    });

    // CSRF helper
    function getCSRFToken() {
      const match = document.cookie.match(/csrftoken=([^;]+)/);
      return match ? match[1] : "";
    }

    // Load restricted countries into dropdown
    async function loadCountries() {
      try {
        const res = await fetch(`${API_BASE}/country/`, {
          headers: {"Content-Type":"application/json"},
          credentials: "include"
        });
        if(!res.ok) throw new Error("Failed to fetch countries");
        const countries = await res.json();

        const nationalitySel = document.getElementById("regNationality");
        countries.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.code;
          opt.textContent = c.name;
          nationalitySel.appendChild(opt);
        });
      } catch (err) {
        console.error("Failed to load countries", err);
      }
    }

    loadCountries();
  </script>
</body>
</html>
